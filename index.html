<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å…¬è»Šè·¯å¾‘è¦åŠƒç³»çµ±</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; margin: 0; padding: 20px; }
        .main-container { display: flex; gap: 20px; width: 1000px; height: 620px; }
        /* å›ºå®šç•«å¸ƒå°ºå¯¸ï¼Œé˜²æ­¢è®Šå½¢ */
        #mapCanvas { background: white; border: 2px solid #333; width: 600px; height: 600px; flex-shrink: 0; }
        .panel { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button { padding: 10px; cursor: pointer; border: 1px solid #ccc; background: #eee; border-radius: 4px; font-weight: bold; }
        button.active { background: #3498db; color: white; }
        #btn-run { background: #27ae60; color: white; grid-column: span 2; margin-top: 10px; border: none; }
        .result-box { margin-top: 15px; background: #2c3e50; color: #fff; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; font-size: 13px; }
    </style>
</head>
<body>
    <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <div id="technical-report" style="padding: 40px; background: #fff; border-bottom: 4px solid #34495e; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;">
        <h1 style="text-align: center; color: #2c3e50; font-size: 2em; margin-bottom: 10px;">é¡Œç›®äºŒï¼šå…¬è»Šè·¯ç·šèˆ‡ç«™é»è¨­ç½®è¦åŠƒ</h1>

        <div style="max-width: 1100px; margin: 0 auto;">
            
        <section style="margin-bottom: 40px; background: #fdfdfd; padding: 25px; border-radius: 12px; border: 1px solid #eee;">
            <h2 style="color: #2980b9; border-left: 6px solid #2980b9; padding-left: 15px; margin-bottom: 20px;">(1). å•é¡Œå»ºæ¨¡ï¼šåœ–è«–èˆ‡æ‹‰æ ¼æœ—æ—¥æœ€ä½³åŒ–</h2>
            <p>æœ¬ç³»çµ±å°‡å•é¡Œå»ºæ¨¡ç‚ºæœ€å°åŒ–<b>æ‹‰æ ¼æœ—æ—¥å‡½æ•¸ (Lagrangian Function)</b> \(L\)ï¼Œç”¨ä»¥å¹³è¡¡ç‡Ÿé‹æ”¯å‡ºèˆ‡æœå‹™å“è³ªï¼š</p>
            
            <div style="background: #fff; padding: 20px; border-radius: 10px; text-align: center; margin: 25px 0; font-size: 1.3em; border: 2px solid #3498db; color: #2c3e50;">
                $$L = w_1 \cdot (n \cdot S_{cost} + Dist_{bus} \cdot C_{bus}) + w_2 \cdot \sum dist(p_i, s_{nearest})$$
            </div>

            <p>å…¬å¼å„é …è®Šæ•¸èˆ‡å­å•é¡Œä¹‹å°æ‡‰å¦‚ä¸‹ï¼š</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px;">
                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #e67e22;">
                    <h4 style="margin-top: 0; color: #d35400;">å•é¡Œ 1ï¼šç‡Ÿé‹æˆæœ¬</h4>
                    <p>å°æ‡‰å…¬å¼ä¸­çš„å‰é … \((n \cdot S_{cost} + Dist_{bus} \cdot C_{bus})\)ï¼š</p>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        <li><b>\(n\)</b>ï¼šé è¨ˆè¨­ç½®çš„ä¸­ç¹¼ç«™é»ç¸½æ•¸ã€‚</li>
                        <li><b>\(S_{cost}\)</b>ï¼šå–®ä¸€ç«™é»çš„å›ºå®šå»ºè¨­èˆ‡ç¶­è­·æˆæœ¬ã€‚</li>
                        <li><b>\(Dist_{bus}\)</b>ï¼šå…¬è»Šå¾èµ·é» A ç¶“ç”±æ‰€æœ‰ç«™é»è‡³çµ‚é» B çš„ç¸½è¡Œé§›é‡Œç¨‹ã€‚</li>
                        <li><b>\(C_{bus}\)</b>ï¼šå…¬è»Šæ¯å–®ä½è·é›¢çš„ç‡Ÿé‹æˆæœ¬ã€‚</li>
                    </ul>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #e67e22;">
                    <h4 style="margin-top: 0; color: #d35400;">å•é¡Œ 2ï¼šè¡Œäººä¾¿æ·æˆæœ¬</h4>
                    <p>å°æ‡‰å…¬å¼ä¸­çš„å¾Œé … \(\sum dist(p_i, s_{nearest})\)ï¼š</p>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        <li><b>\(p_i\)</b>ï¼šç¬¬ \(i\) ä½ä¹˜å®¢çš„åº§æ¨™ä½ç½®ã€‚</li>
                        <li><b>\(s_{nearest}\)</b>ï¼šè·é›¢è©²ä¹˜å®¢æœ€è¿‘çš„å…¬è»Šç«™é»åº§æ¨™ã€‚</li>
                        <li><b>\(dist\)</b>ï¼šå…©é»é–“çš„ <b>\(L_2\) è·é›¢</b>ã€‚ç¸½å’Œä»£è¡¨æ‰€æœ‰ä¹˜å®¢æ­¥è¡Œè² æ“”ã€‚</li>
                        <li><b>\(w_1, w_2\)</b>ï¼šä»£è¡¨æ”¿åºœç‡Ÿé‹èˆ‡æ°‘çœ¾ä¾¿æ·é–“çš„æ¬Šé‡å„ªå…ˆé †åºã€‚</li>
                    </ul>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <h4 style="margin-top: 0; color: #27ae60;">å•é¡Œ 3ï¼šé¿éšœæœ€çŸ­è·¯å¾‘ (A* Search)</h4>
                    <p>è€ƒé‡ç³»çµ±æ•ˆèƒ½èˆ‡è¨ˆç®—æ•ˆç‡ï¼Œæˆ‘å€‘å°‡å…¬è»Šç§»å‹•è·¯å¾‘é™åˆ¶æ–¼ç¶²æ ¼å…§çš„ <b>8 å€‹é›¢æ•£æ–¹å‘</b>ã€‚æ­¤è¨­è¨ˆçš„ä¸»è¦ç›®çš„æ˜¯ç‚ºäº†ï¼š</p>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        <li><b>é™åˆ¶æœå°‹ç©ºé–“</b>ï¼šå°‡åˆ†æ”¯å› å­æ§åˆ¶åœ¨ \(k=8\)ï¼Œé¿å…é€£çºŒç©ºé–“ä¸‹çš„è¨ˆç®—çˆ†ç‚¸ï¼Œç¢ºä¿å³æ™‚åæ‡‰ã€‚</li>
                        <li><b>å•Ÿç™¼å¼å‡½æ•¸æ‡‰ç”¨</b>ï¼šæ¡ç”¨ Octile è·é›¢é ä¼°å‰©é¤˜è·¯ç¨‹æˆæœ¬ã€‚</li>
                    </ul>
                    <div style="background: #f4f4f4; padding: 10px; font-size: 0.85em; margin: 5px 0;">
                        \(H = (dx + dy) + (1.414 - 2) \cdot \min(dx, dy)\)
                    </div>
                    <p style="font-size: 0.85em;"><small><b>è¨»ï¼š</b>æ­¤å‡½æ•¸å…·å‚™ã€Œå®¹è¨±æ€§ã€ï¼Œèƒ½ç¢ºä¿åœ¨é›¢æ•£è·¯ç¶²é™åˆ¶ä¸‹ï¼Œæ±‚å¾—ç‡Ÿé‹æˆæœ¬ \(Dist_{bus}\) çš„ç†è«–æœ€ä½³è§£ã€‚</small></p>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <h4 style="margin-top: 0; color: #27ae60;">å•é¡Œ 4ï¼šæœ€ä½³ç«™é»ä½ˆç½®</h4>
                    <p>é€™æ˜¯ä¸€å€‹å‹•æ…‹æ±ºç­–å•é¡Œã€‚æˆ‘å€‘éœ€åœ¨ç¦å€é™åˆ¶ä¸‹ï¼Œé€éæ¼”ç®—æ³•æ‰¾åˆ°ä¸€çµ„å€™é¸åº§æ¨™é›†åˆ \(\{s_1, s_2, ..., s_n\}\)ï¼Œä½¿å‡½æ•¸ \(L\) é”åˆ°æœ€å°å€¼ã€‚æ­¤éç¨‹éœ€åŒæ™‚è€ƒæ…®è·¯å¾‘é€£é€šæ€§èˆ‡ä¹˜å®¢è¦†è“‹ç‡ã€‚</p>
                </div>
            </div>
        </section>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 40px 0;">

        <section style="margin-top: 40px; background: #fdfdfd; padding: 25px; border-radius: 12px; border: 1px solid #eee;">
            <h2 style="color: #2980b9; border-left: 6px solid #2980b9; padding-left: 15px; margin-bottom: 20px;">(2). æœ€ä½³åŒ–ç«™é»ä½ˆç½®ï¼šæœå°‹ç©ºé–“èˆ‡ç­–ç•¥æ¯”è¼ƒ</h2>
            
            <p>åœ¨å·²çŸ¥<b>ç¦å€é™åˆ¶</b>èˆ‡<b>è¡Œäººåº§æ¨™</b>çš„æƒ…æ³ä¸‹ï¼Œæœå°‹æœ€ä½³ç«™é»ä½ˆç½®èˆ‡ç«™é»é †åºæ˜¯ä¸€å€‹é«˜åº¦è¤‡é›œçš„æœ€ä½³åŒ–å•é¡Œã€‚æˆ‘å€‘çš„ç›®æ¨™æ˜¯åœ¨å¯æ¥å—çš„æ™‚é–“å…§ï¼Œæ‰¾å‡ºèƒ½ä½¿æˆæœ¬å‡½æ•¸ \(L\) é”åˆ°å±€éƒ¨æœ€ä½³æˆ–å…¨åŸŸæœ€ä½³çš„ç«™é»çµ„åˆã€‚</p>

            <div style="background: #fff; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #e9ecef;">
                <h4 style="margin-top: 0; color: #34495e;">æœå°‹ç©ºé–“çš„è½‰åŒ–</h4>
                <p style="font-size: 0.95em;">
                    é›–ç„¶æˆ‘å€‘å¯ä»¥å°‡æ­¤å•é¡Œè¦–ç‚ºä¸€å€‹å…¨åœ°åœ–çš„<b>çª®èˆ‰å•é¡Œ</b>ï¼Œä½†å…¶è¨ˆç®—è¤‡é›œåº¦æœƒéš¨åœ°åœ–å¤§å°å‘ˆå¹¾ä½•å€æ•¸å¢åŠ ã€‚
                    ç‚ºäº†æ•ˆèƒ½è€ƒé‡ï¼Œç³»çµ±å°‡æœå°‹ç©ºé–“é™åˆ¶åœ¨ä¸€å€‹å…·å‚™é«˜æ½›åŠ›çš„<b>ç«™é»å€™é¸æ± </b>å…§ï¼š
                </p>
                <ul style="font-size: 0.9em; line-height: 1.8;">
                    <li><b>K-Means ç¾¤èšä¸­å¿ƒ</b>ï¼šé‡å°è¡Œäººé€²è¡Œåˆ†ç¾¤ï¼Œæ‰¾åˆ°èƒ½ä»£è¡¨å„è‡ªäººç¾¤çš„å¹³å‡è·é›¢æœ€è¿‘çš„åº§æ¨™ã€‚</li>
                    <li><b>è¡Œäººè‡ªèº«åº§æ¨™</b>ï¼šç¢ºä¿"æ­¥è¡Œè·é›¢æœ€å°åŒ–"çš„æ½›åœ¨ç«™é»ä½ç½®ã€‚</li>
                </ul>
                <p style="font-size: 0.95em;">
                    <b>è·¯å¾‘ä¸€è‡´æ€§æœ€ä½³åŒ–ï¼š</b> 
                    æ‡‰æ³¨æ„çš„æ˜¯ï¼Œæ–°æ’å…¥çš„å…¬è»Šç«™é»å¿…é ˆç¬¦åˆ"å¾ A åˆ° B æ—¢æœ‰è·¯ç·šä¸­ï¼Œè·é›¢æ’å…¥é»é‚Šéš›æˆæœ¬æœ€å°çš„å…©å€‹ç¯€é»ä¸­é–“"ï¼Œ
                    æ‰ä¸æœƒå°è‡´è·¯å¾‘éœ‡ç›ªï¼ˆä¾‹å¦‚ï¼šåœ¨æ²³æµå…©å²¸å¤šæ¬¡å¾€è¿”éæ²³ï¼‰ï¼Œç¢ºä¿ç‡Ÿé‹é‡Œç¨‹çš„æœ€ä½³åŒ–ã€‚
                </p>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-top: 25px; background: white; font-size: 0.95em; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <thead>
                    <tr style="background: #34495e; color: white;">
                        <th style="padding: 12px; border: 1px solid #ddd; width: 25%;">æœå°‹ç­–ç•¥</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">å„ªé»</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ç¼ºé»</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">é©ç”¨æƒ…å¢ƒ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #c0392b;">å…¨åœ°åœ–çª®èˆ‰<br>(Exhaustive Search)</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">èƒ½ä¿è­‰æ‰¾åˆ°<b>å…¨åŸŸæœ€ä½³è§£</b>ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">æœå°‹æ™‚é–“æ¥µé•·ï¼Œç„¡æ³•åœ¨å³æ™‚äº’å‹•ç³»çµ±ä¸­ä½¿ç”¨ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">åœ°åœ–æ¥µå°æˆ–éœæ…‹é å…ˆè¦åŠƒã€‚</td>
                    </tr>
                    <tr style="background: #f9f9f9;">
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #27ae60;">å•Ÿç™¼å¼è²ªå©ªæ³•<br>(Heuristic Greedy)</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">é‡å° [K-Meansã€è¡Œäººåº§æ¨™] é€²è¡Œç¯©é¸ï¼Œé‹ç®—æ¥µå¿«ä¸”çµæœæ¥è¿‘æœ€ä½³è§£ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">å¯èƒ½é™·å…¥å±€éƒ¨æœ€ä½³è§£ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;"><b>å³æ™‚æ±ºç­–æ”¯æ´ã€å‹•æ…‹ä¹˜å®¢è®Šæ›´ã€‚</b></td>
                    </tr>
                </tbody>
            </table>
            
            <p style="margin-top: 20px; font-size: 0.9em; background: #fff8e1; padding: 10px; border-left: 5px solid #ffc107; border-radius: 4px;">
                <b>ç³»çµ±æœ€çµ‚æ¡ç”¨ï¼š</b> å•Ÿç™¼å¼è²ªå©ªæœå°‹ã€‚é€éå°‡æœå°‹ç¯„åœèšç„¦æ–¼é—œéµå€™é¸åº§æ¨™ï¼Œæˆ‘å€‘èƒ½åœ¨çŸ­æ™‚é–“å…§è¨ˆç®—å‡ºå…¼é¡§å»ºç½®æˆæœ¬ \(w_1\) èˆ‡æœå‹™å“è³ª \(w_2\) çš„ç«™é»ä½ˆç½®ã€‚
            </p>
        </section>

        <section style="margin-top: 40px; background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e1e8ed;">
            <h2 style="color: #2980b9; border-left: 6px solid #2980b9; padding-left: 15px; margin-bottom: 20px;">(3). è·¯å¾‘ç”ŸæˆæŠ€è¡“ç´°ç¯€ï¼šOctile A* æ¼”ç®—æ³•</h2>

            <p>è·¯å¾‘ç”Ÿæˆæ¨¡çµ„è² è²¬åœ¨èµ·é»ã€å„ç«™é»èˆ‡çµ‚é»ä¹‹é–“å»ºç«‹åˆæ³•çš„ç‰©ç†é€£ç·šã€‚ç³»çµ±çš„æ ¸å¿ƒå¼•æ“æ˜¯ A* æ¼”ç®—æ³•ï¼Œä¸¦é‡å°ç¶²æ ¼åœ°åœ–é€²è¡Œäº†æœ€ä½³åŒ–ã€‚</p>

            <div style="margin-bottom: 25px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">1. æ ¸å¿ƒæ¼”ç®—æ³•ï¼šA-Star</h4>
                <p style="font-size: 0.92em; line-height: 1.6;">
                    ç³»çµ±æ¡ç”¨ A* æ¼”ç®—æ³•ä½œç‚ºè·¯å¾‘è¦åŠƒå¼•æ“ã€‚é€éå•Ÿç™¼å¼ä¼°è¨ˆå‡½æ•¸ï¼ˆHeuristicï¼‰å¼•å°æœå°‹ï¼Œç¢ºä¿å…¬è»Šèƒ½å¾èµ·é» A ç¶“ç”±å„å€‹å„ªåŒ–ç«™é»åˆ°é”çµ‚é» Bã€‚è©²æ¼”ç®—æ³•é€éç¶­è­·ä¸€å€‹å„ªå…ˆéšŠåˆ—ï¼Œå„ªå…ˆæ¢ç´¢ç¸½é ä¼°æˆæœ¬ \( f(n) = g(n) + h(n) \) æœ€å°çš„ç¯€é»ã€‚
                </p>
            </div>

            <div style="margin-bottom: 25px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">2. ç§»å‹•è¦å‰‡ï¼šOctile Distance (å…«å‘ç§»å‹•é™åˆ¶)</h4>
                <p style="font-size: 0.92em; line-height: 1.6; margin-left: 5px;">
                    ç‚ºäº†æ¨¡æ“¬çœŸå¯¦çš„é“è·¯è½‰å‘ï¼Œæˆ‘å€‘ä¸ä½¿ç”¨å››æ–¹å‘ç§»å‹•ï¼ˆæ›¼å“ˆé “è·é›¢ï¼‰ï¼Œæ¡ç”¨ <b>Octile è·é›¢</b> è¦ç¯„ï¼š
                </p>
                <ul style="font-size: 0.9em; line-height: 1.8; margin-left: 5px;">
                    <li><b>ç§»å‹•æ¬Šé‡</b>ï¼šæ°´å¹³èˆ‡å‚ç›´ç§»å‹•æˆæœ¬ç‚º \( 1.0 \)ï¼Œå°è§’ç·šï¼ˆ45åº¦è§’ï¼‰ç§»å‹•æˆæœ¬ç‚º \( \sqrt{2} \approx 1.414 \)ã€‚</li>
                    <li><b>æ•ˆæœ</b>ï¼šé€™ä½¿å¾—è·¯å¾‘è¦–è¦ºä¸Šä¸å†æ˜¯åƒµç¡¬çš„ 90 åº¦è½‰å½ï¼Œè€Œæ˜¯èƒ½ä»¥æ–œå‘ç©¿æ¢­æ–¼å»ºç¯‰ç‰©é–“ï¼Œæ›´è²¼è¿‘ç¾å¯¦é“è·¯æ¨£æ…‹ã€‚</li>
                </ul>
            </div>

            <div style="margin-bottom: 10px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">3. éšœç¤™ç‰©é¿è®“èˆ‡é€£é€šæ€§</h4>
                <p style="font-size: 0.92em; line-height: 1.6;">
                    æ¼”ç®—æ³•åœ¨æœå°‹éç¨‹ä¸­æœƒå³æ™‚æ¯”å° <b>wallsSet</b> æ•¸æ“šã€‚æ¯ç•¶æœå°‹åˆ°æ–°ç¯€é»æ™‚ï¼Œç³»çµ±æœƒç«‹å³æª¢æŸ¥è©²åº§æ¨™æ˜¯å¦å±¬æ–¼ç¦å€ï¼š
                </p>
                <div style="background: #2d3436; color: #fab1a0; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; border-radius: 5px; margin: 10px 0;">
                    if (wallsSet.has(`${nextX},${nextY}`)) continue; // ç«‹å³æ¨æ£„ç‰†å…§è·¯å¾‘
                </div>
                <p style="font-size: 0.92em;">
                    é€™ç¢ºä¿äº†ç”Ÿæˆçš„è·¯å¾‘çµ•å°ä¸æœƒé‡ç–Šæ–¼ä»»ä½•ç¦å€åº§æ¨™ã€‚åœ¨ <b>Toy Demo</b> çš„æ²³æµå ´æ™¯ä¸­ï¼Œæ¼”ç®—æ³•æœƒè‡ªå‹•é–å®šå”¯ä¸€åˆæ³•çš„æ©‹æ¨‘ç¯€é» <b>(10, 10)</b> ä½œç‚ºè·¨å€è·¯å¾‘çš„å¿…ç¶“ä¹‹è™•ï¼Œå±•ç¾äº†æ¼”ç®—æ³•çš„ç’°å¢ƒæ„ŸçŸ¥èˆ‡è¦åŠƒèƒ½åŠ›ã€‚
                </p>
                
            </div>
            <div style="margin-bottom: 10px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">4. å¤šç«™é»åºåˆ—ç”Ÿæˆï¼šå¾ç©ºè·¯å¾‘åˆ°å‹•æ…‹æ’å…¥</h4>
                <p style="font-size: 0.92em; line-height: 1.6; margin-left: 5px;">
                    è·¯å¾‘ç”Ÿæˆä¸¦éä¸€æ¬¡æ€§å®Œæˆï¼Œè€Œæ˜¯éš¨å„ªåŒ–éç¨‹å¾"ç©ºç™½è·¯å¾‘ == [A,B]"é€æ­¥æ¼”é€²ï¼š
                </p>
                <div style="background: #f0f4f8; padding: 20px; border-radius: 8px; border-left: 5px solid #27ae60; margin-left: 5px; margin-top: 10px;">
                    <ul style="font-size: 0.9em; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><b>åˆå§‹åŒ–éšæ®µï¼š</b> æ­¤æ™‚ç«™é»æ¸…å–®ç‚ºç©ºï¼Œç³»çµ±å…ˆå»ºç«‹åŸºç¤ <b>[A] â†’ [B]</b> è»Œè·¡ä½œç‚ºåŸºæº–æˆæœ¬ã€‚</li>
                        <li><b>é€ä¸€å€™é¸è©•ä¼°ï¼š</b> é¸å®šä¸€å€‹å…·å‚™æ½›åŠ›çš„å€™é¸é» \( S \) æ™‚ï¼Œç³»çµ±æœƒæƒæç•¶å‰åºåˆ—ä¸­æ‰€æœ‰çš„ã€Œè·¯æ®µé–“éš™ã€ã€‚</li>
                        <li><b>åŸ·è¡Œæœ€çœæˆæœ¬æ’å…¥ï¼š</b> 
                            é€éå…¬å¼ \( \Delta Dist = Dist(N_i, S) + Dist(S, N_{i+1}) - Dist(N_i, N_{i+1}) \)ï¼Œ
                            å°‡è©²å€™é¸é»ç½®æ–¼ <b>å¢åŠ æˆæœ¬æœ€å°</b> çš„ä½ç½®ï¼Œç¢ºä¿åœ°ç†é€£çºŒæ€§ã€‚
                        </li>
                        <li><b>éè¿´å¢é•·ï¼š</b> æ¯æˆåŠŸæ’å…¥ä¸€å€‹é»ï¼Œä¾¿å½¢æˆæ–°çš„è·¯å¾‘åŸºæº–ã€‚æ­¤éç¨‹ä¸æ–·é‡è¤‡ï¼Œç›´åˆ°æ–°å¢ä»»ä½•å€™é¸é»éƒ½ç„¡æ³•å†é™ä½ç¸½æˆæœ¬å‡½æ•¸ \( L \) ç‚ºæ­¢ã€‚</li>
                    </ul>
                </div>
                
                <p style="font-size: 0.85em; color: #c0392b; margin-top: 10px; margin-left: 5px;">
                    <i>â€» è¨»ï¼šæ­¤å‹•æ…‹æ’å…¥æ©Ÿåˆ¶æœ‰æ•ˆè§£æ±ºäº†å¤šç«™é»ç’°å¢ƒä¸‹ï¼Œå› æ’åºä¸ç•¶å°è‡´çš„ã€Œåè¦†éæ²³ã€æˆ–ã€Œå¤§å¹…ç¹è·¯ã€ç­‰éæœ€å„ªè§£å•é¡Œã€‚</i>
                </p>
            </div>


        </section>
            
        </div>
    </div>



    <h2 style="margin-bottom:10px;">ğŸšŒ å…¬è»Š LRP è¦åŠƒå·¥å…· (Hybrid Python)</h2>
    <div id="pyscript-loading" style="color:orange; font-weight:bold;">ç³»çµ±æ ¸å¿ƒè¼‰å…¥ä¸­...</div>

    <div class="main-container">
        <canvas id="mapCanvas" width="600" height="600"></canvas>

    <div class="panel">
        <div class="btn-group">
            <button onclick="setMode('wall')" id="btn-wall" class="active">ğŸš« ç¦å€</button>
            <button onclick="setMode('passenger')" id="btn-passenger">ğŸ‘¤ ä¹˜å®¢</button>
            <button onclick="setMode('station')" id="btn-station">ğŸš ç«™ç‰Œ</button>
            <button onclick="resetMap()" style="background:#e74c3c; color:white;">ğŸ—‘ï¸ æ¸…ç©º</button>
            <button id="btn-run" onclick="triggerOptimization()">ğŸš€ åŸ·è¡Œé‹ç®—</button>
            <button id="btn-auto" onclick="triggerAutoOptimize()" style="background:#9b59b6; color:white; grid-column: span 2; margin-top: 5px; border: none;">ğŸ¤– AI è‡ªå‹•é¸å€ (Lagrangian)</button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                ç‡Ÿé‹æ¬Šé‡ w1: <span id="w1-v" style="color: #27ae60; float: right;">1.0</span>
            </label>
            <input type="range" id="w1" min="0" max="10" step="0.5" value="1.0" oninput="updateWeights()" style="width: 100%; cursor: pointer;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                æ­¥è¡Œæ¬Šé‡ w2: <span id="w2-v" style="color: #3498db; float: right;">1.0</span>
            </label>
            <input type="range" id="w2" min="0" max="10" step="0.5" value="1.0" oninput="updateWeights()" style="width: 100%; cursor: pointer;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                ç«™ç‰Œè¨­ç½®æˆæœ¬ (S): <span id="s-cost-v" style="color: #e67e22; float: right;">10</span>
            </label>
            <input type="number" id="s-cost" value="10" min="0" step="1" oninput="updateWeights()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                å…¬è»Šè¡Œèµ°æˆæœ¬ (C): <span id="c-bus-v" style="color: #7f8c8d; float: right;">1.0</span>
            </label>
            <input type="number" id="c-bus" value="1.0" min="0.1" step="0.1" oninput="updateWeights()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
        </div>

        <div class="result-box" id="py-output">ç­‰å¾…æŒ‡ä»¤...</div>
    </div>

    </div>

<script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 30;
    
    window.wallsArray = [];
    window.passengers = [];
    window.stations = [];
    let mode = 'wall';
    let wallsSet = new Set();


    function setMode(m) {
        mode = m;
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + m).classList.add('active');
    }

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / (rect.width / 20));
        const y = Math.floor((e.clientY - rect.top) / (rect.height / 20));
        
        if (mode === 'wall') {
            const key = `${x},${y}`;
            if (wallsSet.has(key)) wallsSet.delete(key); else wallsSet.add(key);
            window.wallsArray = Array.from(wallsSet);
        } else if (mode === 'passenger') window.passengers.push({x, y});
        else if (mode === 'station') window.stations.push({x, y});
        drawBase();
    });

    function resetMap() {
        wallsSet.clear(); window.wallsArray=[]; window.passengers=[]; window.stations=[];
        drawBase();
    }

    function updateWeights() {
        document.getElementById('w1-v').innerText = document.getElementById('w1').value;
        document.getElementById('w2-v').innerText = document.getElementById('w2').value;
        document.getElementById('s-cost-v').innerText = document.getElementById('s-cost').value;
        document.getElementById('c-bus-v').innerText = document.getElementById('c-bus').value;
    }
    
    function triggerOptimization() {
        if (window.runOptimization) window.runOptimization();
    }
    function triggerAutoOptimize() {
        if (window.autoOptimize) {
            document.getElementById('py-output').innerText = "AI æ­£åœ¨è¨ˆç®—æœ€ä½³ç«™é»é…ç½®...";
            window.autoOptimize(); // å‘¼å« Python çš„å„ªåŒ–å‡½å¼
        }
    }

    // é€™å€‹å‡½å¼è®“ Python ç®—å®Œå¾Œï¼ŒæŠŠç«™é»ä½ç½®æ›´æ–°åˆ°åœ°åœ–ä¸Š
    window.updateStationsFromPy = function(newStationsProxy) {
        // å°‡ Python è³‡æ–™è½‰å› JS æ ¼å¼
        window.stations = Array.from(newStationsProxy).map(p => ({
            x: (typeof p.x !== 'undefined') ? p.x : p.get('x'),
            y: (typeof p.y !== 'undefined') ? p.y : p.get('y')
        }));
        drawBase(); // é‡æ–°ç•«åœ–ï¼Œè®“ç«™é»å‡ºç¾åœ¨ç•«é¢ä¸Š
    };
    

    function drawBase() {
        ctx.clearRect(0, 0, 600, 600);
        ctx.strokeStyle = '#eee';
        for(let i=0; i<20; i++) {
            for(let j=0; j<20; j++) {
                ctx.strokeRect(i*30, j*30, 30, 30);
                if(wallsSet.has(`${i},${j}`)) {
                    ctx.fillStyle = '#ff7675';
                    ctx.fillRect(i*30, j*30, 30, 30);
                }
            }
        }
        window.passengers.forEach(p => drawPoint(p.x, p.y, '#3498db', 'P'));
        window.stations.forEach((s,i) => drawPoint(s.x, s.y, '#2ecc71', 'S'+(i+1)));
        drawPoint(1, 1, 'gold', 'A'); drawPoint(18, 18, 'orange', 'B');
    }

    function drawPoint(x, y, color, label) {
        const cx = x * 30 + 15;
        const cy = y * 30 + 15;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é‡ç–Š (é€éæ¨™ç±¤é–‹é ­åˆ¤æ–·)
        const isStation = label.startsWith('S');
        const isPassenger = label.startsWith('P');

        ctx.save();
        
        if (isStation) {
            // ç«™é»ç•«å¤§ä¸€é»ï¼Œç•¶ä½œåº•åº§
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(cx, cy, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // æ¨™ç±¤å¯«åœ¨ä¸Šæ–¹
            ctx.fillStyle = "black";
            ctx.font = "bold 10px Arial";
            ctx.textAlign = "center";
            ctx.fillText(label, cx, cy - 14);
        } 
        else if (isPassenger) {
            // ä¹˜å®¢ç•«å°ä¸€é»ï¼Œä¸¦åŠ ä¸Šé™°å½±/é‚Šæ¡†
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(cx, cy, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 1.5;
            ctx.stroke();
            
            // æ¨™ç±¤å¯«åœ¨ä¸‹æ–¹
            ctx.fillStyle = "#2980b9";
            ctx.font = "9px Arial";
            ctx.textAlign = "center";
            ctx.fillText(label, cx, cy + 18);
        } 
        else {
            // èµ·é»(A)èˆ‡çµ‚é»(B)ç¶­æŒåŸæ¨£
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(cx, cy, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.fillText(label, cx - 5, cy + 4);
        }
        
        ctx.restore();
    }
    
    // é—œéµä¿®æ­£ï¼šç¢ºä¿ path æ˜¯ç´” JS é™£åˆ—
    window.renderPath = function(pathProxy, color, isDashed) {
        // å¼·åˆ¶è½‰æ›ï¼šè™•ç† Python Proxy ç‰©ä»¶ï¼Œç¢ºä¿è½‰æˆç´” JS Array
        let rawPath = Array.from(pathProxy);
        let path = rawPath.map(p => {
            // å…¼å®¹è™•ç†ï¼šåŒæ™‚å˜—è©¦è®€å–å±¬æ€§èˆ‡å­—å…¸ key
            let x = (typeof p.x !== 'undefined') ? p.x : p.get('x');
            let y = (typeof p.y !== 'undefined') ? p.y : p.get('y');
            return { x: Number(x), y: Number(y) };
        });

        if (path.length < 2) return;

        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = isDashed ? 2 : 4;
        if (isDashed) ctx.setLineDash([5, 5]);
        
        // ç¹ªè£½è·¯å¾‘ä¸»é«”
        ctx.moveTo(path[0].x * 30 + 15, path[0].y * 30 + 15);
        for (let i = 1; i < path.length; i++) {
            ctx.lineTo(path[i].x * 30 + 15, path[i].y * 30 + 15);
        }
        ctx.stroke();

        // ç¹ªè£½ç®­é ­
        ctx.setLineDash([]);
        ctx.fillStyle = color;
        
        // éæ­·è·¯å¾‘ç•«ç®­é ­
        for (let i = 1; i < path.length; i++) {
            // å…¬è»Šå¯¦ç·š(æ©˜)ï¼šæ¯ä¸€æ ¼ä¸­é–“éƒ½ç•«ï¼›è¡Œäººè™›ç·š(è—)ï¼šåªåœ¨æœ€å¾Œä¸€æ ¼(ç«™é»è™•)ç•«
            if (!isDashed || i === path.length - 1) {
                drawArrowhead(path[i-1], path[i], color, isDashed ? 8 : 12);
            }
        }
        ctx.restore();
    };
    function drawArrowhead(from, to, color, size) {
        const tx = to.x * 30 + 15;
        const ty = to.y * 30 + 15;
        const fx = from.x * 30 + 15;
        const fy = from.y * 30 + 15;
        
        // è¨ˆç®—è§’åº¦
        const angle = Math.atan2(ty - fy, tx - fx);
        
        ctx.beginPath();
        ctx.moveTo(tx, ty); // ç®­é ­å°–ç«¯åœ¨ç›®æ¨™é»ä¸­å¿ƒ
        // ç¹ªè£½å…©ç¿¼
        ctx.lineTo(tx - size * Math.cos(angle - Math.PI/6), ty - size * Math.sin(angle - Math.PI/6));
        ctx.lineTo(tx - size * Math.cos(angle + Math.PI/6), ty - size * Math.sin(angle + Math.PI/6));
        ctx.closePath();
        ctx.fill();
    }
    window.onload = () => drawBase();

    function loadToyDemo() {
        console.log("æ­£åœ¨é‡ç½® Toy Demo...");
        
        // 1. å®Œå…¨æ¸…ç©ºç¾æœ‰æ•¸æ“š
        wallsSet.clear(); // å‹™å¿…æ¸…ç©º Setï¼Œå¦å‰‡èˆŠç‰†æœƒç•™è‘—
        window.wallsArray = [];
        window.passengers = [];
        window.stations = []; 

        // 2. åœ°å½¢å»ºè¨­ï¼šä¸­å¤®æ²³æµ
        for (let x = 0; x < 20; x++) {
            if (x !== 10) {
                wallsSet.add(`${x},10`); // åŒæ­¥æ›´æ–°åˆ° Set ä¾› drawBase ä½¿ç”¨
            }
        }

        // 3. åœ°å½¢å»ºè¨­ï¼šå³ä¸‹è§’ã€Œå°é–‰å¼ç¤¾å€ã€
        for (let x = 12; x <= 16; x++) {
                for (let y = 12; y <= 16; y++) {
                    // å¦‚æœæ˜¯å¤–æ¡†ä¸”ä¸æ˜¯é–€å£ (14,16)
                    if ((x === 12 || x === 16 || y === 12 || y === 16) && !(x === 14 && y === 16)) {
                        wallsSet.add(`${x},${y}`);
                    }
                }
            }
        // 4. åœ°å½¢å»ºè¨­ï¼šå·¦ä¸Šè§’ã€ŒåŠé–‹æ”¾å¼ç¤¾å€ã€
        const openWalls = [
            [3, 3], [4, 3], [6, 3], [7, 3], // Y=3 æ©«å‘æœ‰ç¼ºå£
            [3, 5], [5, 5], [7, 5],         // Y=5 éŒ¯è½åˆ†ä½ˆ
            [4, 7], [6, 7]                  // Y=7 å¯¬é¬†åˆ†ä½ˆ
        ];
        openWalls.forEach(w => wallsSet.add(`${w[0]},${w[1]}`));

        // 5. åŒæ­¥ wallsArray (è½‰æˆ Python èªè­˜çš„æ ¼å¼)
        window.wallsArray = Array.from(wallsSet);

        // 6. æ”¾ç½® 20 ä½è¡Œäºº
        const p = [];
        p.push({x: 2, y: 2}, {x: 5, y: 2}, {x: 8, y: 3}, {x: 15, y: 2}, {x: 18, y: 3});
        for(let i=0; i<8; i++) {
            p.push({x: 13 + (i%3), y: 13 + Math.floor(i/3)});
        }
        p.push({x: 4, y: 14}, {x: 5, y: 15}, {x: 2, y: 18}, {x: 8, y: 12}, {x: 12, y: 18}, {x: 8, y: 17}, {x: 15, y: 18});        window.passengers = p;

        // 7. æ›´æ–°ç•«é¢ï¼šä½ çš„ç¹ªåœ–å‡½æ•¸åç¨±æ˜¯ drawBase
        if(document.querySelector("#w1")) document.querySelector("#w1").value = 1.0;
        if(document.querySelector("#w2")) document.querySelector("#w2").value = 1.0;
        drawBase();
    }

    window.addEventListener('DOMContentLoaded', () => {
        // ç¨å¾®å»¶é²ç¢ºä¿ Pyodide æº–å‚™å°±ç·’
        setTimeout(() => {
            loadToyDemo();
            // ç¢ºä¿åŸ·è¡Œ drawBase
            if (typeof drawBase === 'function') {
                drawBase();
            }
        }, 500); 
    });

</script>

<script type="py">
from pyscript import window, document
import math

class AStar:
    def solve(self, start, end, walls):
        # ç¢ºä¿ start/end æ˜¯æ•´æ•¸
        sx, sy = int(round(start['x'])), int(round(start['y']))
        ex, ey = int(round(end['x'])), int(round(end['y']))
        
        open_set = [{'x': sx, 'y': sy}]
        came_from = {}
        g = {(sx, sy): 0}
        
        while open_set:
            curr = min(open_set, key=lambda n: g[(n['x'], n['y'])] + self.heuristic(n, {'x': ex, 'y': ey}))
            
            if curr['x'] == ex and curr['y'] == ey:
                res = []
                while (curr['x'], curr['y']) in came_from:
                    res.append(curr)
                    curr = came_from[(curr['x'], curr['y'])]
                res.append({'x': sx, 'y': sy})
                return res[::-1]
            
            open_set.remove(curr)
            
            # 8 æ–¹å‘
            directions = [
                (0, 1, 1), (0, -1, 1), (1, 0, 1), (-1, 0, 1),
                (1, 1, 1.414), (1, -1, 1.414), (-1, 1, 1.414), (-1, -1, 1.414)
            ]
            
            for dx, dy, cost in directions:
                nx, ny = int(curr['x'] + dx), int(curr['y'] + dy)
                
                # --- [é—œéµä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ Tuple æ¯”å°] ---
                if 0 <= nx < 20 and 0 <= ny < 20 and (nx, ny) not in walls:
                    # é¸é…ï¼šé˜²æ­¢æ–œå‘ç©¿éç‰†è§’ç¸«éš™ (å»ºè­°é–‹å•Ÿ)
                    if dx != 0 and dy != 0:
                        if (curr['x'] + dx, curr['y']) in walls and (curr['x'], curr['y'] + dy) in walls:
                            continue

                    new_g = g[(curr['x'], curr['y'])] + cost
                    if new_g < g.get((nx, ny), 9999):
                        came_from[(nx, ny)] = curr
                        g[(nx, ny)] = new_g
                        # æª¢æŸ¥æ˜¯å¦å·²åœ¨ open_set ä¸­ (æ¯”è¼ƒåº§æ¨™è€Œéç‰©ä»¶)
                        if not any(n['x'] == nx and n['y'] == ny for n in open_set):
                            open_set.append({'x': nx, 'y': ny})
                            
        return [{'x': sx, 'y': sy}, {'x': ex, 'y': ey}] # æ‰¾ä¸åˆ°è·¯å¾‘æ™‚å›å‚³ç›´ç·š

    def heuristic(self, a, b):
        dx = abs(a['x'] - b['x'])
        dy = abs(a['y'] - b['y'])
        return (dx + dy) + (1.414 - 2) * min(dx, dy)


def simple_kmeans(points, k, iterations=10):
    if not points or k <= 0: return []
    
    # 1. åˆå§‹ä¸­å¿ƒé»
    centers = [{'x': float(p['x']), 'y': float(p['y'])} for p in points[:k]]
    
    for _ in range(iterations):
        clusters = [[] for _ in range(k)]
        for p in points:
            px, py = float(p['x']), float(p['y'])
            dists = [math.sqrt((px - c['x'])**2 + (py - c['y'])**2) for c in centers]
            idx = dists.index(min(dists))
            clusters[idx].append(p)
        
        new_centers = []
        for i in range(k):
            if not clusters[i]: 
                new_centers.append(centers[i])
                continue
            avg_x = sum(float(p['x']) for p in clusters[i]) / len(clusters[i])
            avg_y = sum(float(p['y']) for p in clusters[i]) / len(clusters[i])
            
            # --- [é—œéµä¿®æ­£ï¼šæœ«å°¾å°é½Š] ---
            # å››æ¨äº”å…¥å¾Œè½‰ç‚º intï¼Œä¸¦ç¢ºä¿å‹åˆ¥æ˜¯èˆ‡ä¹˜å®¢é»ä¸€è‡´çš„ dictionary
            new_centers.append({
                'x': int(round(avg_x)), 
                'y': int(round(avg_y))
            })
        centers = new_centers
        
    return centers

def get_optimal_sequence(start_node, end_node, station_list):
    """
    ä½¿ç”¨ç°¡å–®çš„æ’å…¥å•Ÿç™¼å¼ (Insertion Heuristic) ç¢ºä¿ç«™é»é †åºåˆç†
    """
    optimized_route = [start_node, end_node]
    
    # å°‡ç«™é»ä¸€å€‹ä¸€å€‹æ’å…¥åˆ°æœ€é©åˆçš„ä½ç½®
    for s in station_list:
        best_increase = float('inf')
        best_index = 1
        
        for i in range(len(optimized_route) - 1):
            n1 = optimized_route[i]
            n2 = optimized_route[i+1]
            
            # è¨ˆç®—æ’å…¥è©²ç«™é»å¾Œå¢åŠ çš„é‡Œç¨‹
            # é€™è£¡å¯ä»¥ç›´æ¥ç”¨ Octile è·é›¢å¿«é€Ÿé ä¼°ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½è·‘ A*
            d1 = octile_distance(n1, s)
            d2 = octile_distance(s, n2)
            d_orig = octile_distance(n1, n2)
            
            increase = d1 + d2 - d_orig
            if increase < best_increase:
                best_increase = increase
                best_index = i + 1
        
        optimized_route.insert(best_index, s)
    
    return optimized_route # å›å‚³ [A, S_best1, S_best2, ..., B]

def run_optimization(event=None):
    try:
        raw_walls = window.wallsArray.to_py()
        walls = set()
        for w in raw_walls:
            try:
                if isinstance(w, str) and ',' in w:
                    # è™•ç†å­—ä¸²æ ¼å¼ '9,2' -> è½‰ç‚ºæ•´æ•¸ (9, 2)
                    parts = w.split(',')
                    walls.add((int(parts[0].strip()), int(parts[1].strip())))
                elif hasattr(w, '__getitem__') and len(w) >= 2:
                    # è™•ç†åˆ—è¡¨æ ¼å¼ [9, 2] -> è½‰ç‚ºæ•´æ•¸ (9, 2)
                    walls.add((int(w[0]), int(w[1])))
            except (ValueError, TypeError):
                continue
        print(f"DEBUG - ç‰†å£åº§æ¨™ç¯„ä¾‹: {list(walls)[:5]}")
        ps = window.passengers.to_py()
        ss = window.stations.to_py()
        
        w1 = float(document.querySelector("#w1").value)
        w2 = float(document.querySelector("#w2").value)
        s_cost_unit = float(document.querySelector("#s-cost").value)
        c_bus_unit = float(document.querySelector("#c-bus").value)
        
        window.drawBase()
        solver = AStar()
        
        # 1. è¡Œäººæˆæœ¬èˆ‡æ¸²æŸ“ (L2 è·é›¢)
        ped_total_d = 0
        all_nodes = ss + [{'x': 1, 'y': 1}, {'x': 18, 'y': 18}]
        for p in ps:
            closest_node = min(all_nodes, key=lambda n: math.sqrt((p['x']-n['x'])**2 + (p['y']-n['y'])**2))
            dist = math.sqrt((p['x']-closest_node['x'])**2 + (p['y']-closest_node['y'])**2)
            ped_total_d += dist
            window.renderPath([p, closest_node], "rgba(52, 152, 219, 0.6)", True)

        # 2. å…¬è»Šæˆæœ¬èˆ‡æ¸²æŸ“ (8æ–¹å‘è·¯å¾‘)
        route = [{'x': 1, 'y': 1}] + ss + [{'x': 18, 'y': 18}]
        bus_total_d = 0
        for i in range(len(route)-1):
            seg = solver.solve(route[i], route[i+1], walls)
            for j in range(len(seg)-1):
                dx, dy = abs(seg[j]['x']-seg[j+1]['x']), abs(seg[j]['y']-seg[j+1]['y'])
                bus_total_d += 1.4142 if (dx > 0 and dy > 0) else 1
            window.renderPath(seg, "#f39c12", False)

        # 3. å„é …åˆ†é …æˆæœ¬è¨ˆç®—
        station_total_cost = len(ss) * s_cost_unit  # ç«™ç‰Œæˆæœ¬
        bus_op_cost = w1 * bus_total_d * c_bus_unit # ç‡Ÿé‹æˆæœ¬
        ped_walk_cost = w2 * ped_total_d            # æ­¥è¡Œæˆæœ¬
        
        total_lagrangian = bus_op_cost + ped_walk_cost + station_total_cost
        
        # 4. æ ¼å¼åŒ–è¼¸å‡ºå ±å‘Š
        output =  "ã€ æˆæœ¬çµ±è¨ˆå ±å‘Š ã€‘\n"
        output += f"----------------------------\n"
        output += f"ğŸšŒ å…¬è»Šç¸½è·é›¢: {bus_total_d:.2f}\n"
        output += f"ğŸ’° ç‡Ÿé‹ç¸½æˆæœ¬: {bus_op_cost:.2f} (w1*dist*C)\n"
        output += f"----------------------------\n"
        output += f"ğŸš ç«™ç‰Œç¸½æ•¸é‡: {len(ss)} ç«™\n"
        output += f"ğŸ—ï¸ ç«™ç‰Œç¸½æˆæœ¬: {station_total_cost:.2f} (N*S)\n"
        output += f"----------------------------\n"
        output += f"ğŸš¶ è¡Œäººç¸½æ­¥è¡Œ: {ped_total_d:.2f}\n"
        output += f"ğŸ‘Ÿ æ­¥è¡Œç¸½æˆæœ¬: {ped_walk_cost:.2f} (w2*dist)\n"
        output += f"============================\n"
        output += f"ğŸš€ ç¸½æ‹‰æ ¼æœ—æ—¥æˆæœ¬: {total_lagrangian:.2f}"
        
        document.querySelector("#py-output").innerText = output
        
    except Exception as e:
        document.querySelector("#py-output").innerText = f"é‹ç®—éŒ¯èª¤: {e}"


def get_total_cost(stations, passengers, walls, w1, w2, s_cost, c_bus):
    solver = AStar()
    # 1. å…¬è»Šè·¯å¾‘ (èµ·é» -> æ‰€æœ‰ä¸­ç¹¼ç«™ -> çµ‚é»)
    route = [{'x': 1, 'y': 1}] + stations + [{'x': 18, 'y': 18}]
    bus_d = 0
    for i in range(len(route)-1):
        seg = solver.solve(route[i], route[i+1], walls)
        for j in range(len(seg)-1):
            dx = abs(seg[j]['x'] - seg[j+1]['x'])
            dy = abs(seg[j]['y'] - seg[j+1]['y'])
            # 8æ–¹å‘è·é›¢ç´¯åŠ 
            bus_d += 1.414 if (dx > 0 and dy > 0) else 1
            
    # 2. è¡Œäººæˆæœ¬ï¼šå°‡ [èµ·é», çµ‚é»] èˆ‡ [ç«™é»] åˆä½µè€ƒæ…®
    ped_d = 0
    # é—œéµï¼šé€™è£¡ç¢ºä¿äº†å³ä½¿ stations æ˜¯ç©ºçš„ï¼Œä¹Ÿæœ‰ç¯€é»å¯ä»¥è¨ˆç®—è·é›¢
    all_available_nodes = stations + [{'x': 1, 'y': 1}, {'x': 18, 'y': 18}]
    
    for p in passengers:
        # è¨ˆç®—ä¹˜å®¢åˆ°æœ€è¿‘ç¯€é»çš„ L2 è·é›¢
        dists = [math.sqrt((p['x']-n['x'])**2 + (p['y']-n['y'])**2) for n in all_available_nodes]
        ped_d += min(dists)
        
    return (w1 * bus_d * c_bus) + (w2 * ped_d) + (len(stations) * s_cost)


def is_reachable(p, walls):
    """
    ç²¾ç¢ºæª¢æŸ¥ï¼š1. æ˜¯å¦åœ¨ç‰†å…§ 2. æ˜¯å¦èƒ½é€£é€š
    """
    # ç¢ºä¿åº§æ¨™æ˜¯æ•´æ•¸
    tx, ty = int(p['x']), int(p['y'])
    
    # èª¿æŸ¥ï¼šåœ¨ Python ç«¯å°å‡ºåº§æ¨™ï¼Œè®“ä½ æª¢æŸ¥ X Y æ˜¯å¦åäº†
    print(f"æª¢æŸ¥ä¹˜å®¢ä½ç½®: x={tx}, y={ty}")
    
    # 1. ç‰©ç†æª¢æŸ¥ï¼šå¦‚æœæ˜¯ç‰†ï¼Œç›´æ¥å‰”é™¤
    # æ³¨æ„ï¼šé€™è£¡çš„ (tx, ty) å¿…é ˆèˆ‡ä½ ç•¶åˆå­˜å…¥ walls çš„é †åºå®Œå…¨ä¸€è‡´
    if (tx, ty) in walls:
        print(f"åˆ¤å®šçµæœ: é» ({tx}, {ty}) åœ¨ç‰†å…§ï¼Œå‰”é™¤ã€‚")
        return False
        
    # 2. é€£é€šæª¢æŸ¥
    solver = AStar()
    # èµ·é»å›ºå®šç‚º (1, 1)
    path = solver.solve({'x': 1, 'y': 1}, {'x': tx, 'y': ty}, walls)
    
    reachable = len(path) > 0 or (tx == 1 and ty == 1)
    if not reachable:
        print(f"åˆ¤å®šçµæœ: é» ({tx}, {ty}) æ˜¯å­¤å³¶ï¼Œå‰”é™¤ã€‚")
        
    return reachable    

def fast_dist(p1, p2):
    # æ”¯æ´å­—å…¸æ ¼å¼æˆ–å…ƒçµ„æ ¼å¼
    x1, y1 = (p1['x'], p1['y']) if isinstance(p1, dict) else (p1[0], p1[1])
    x2, y2 = (p2['x'], p2['y']) if isinstance(p2, dict) else (p2[0], p2[1])
    dx, dy = abs(x1 - x2), abs(y1 - y2)
    return (dx + dy) + (1.414 - 2) * min(dx, dy)

def sort_stations_insertion(start_node, end_node, stations):
    """æœ€çœæˆæœ¬æ’å…¥æ³•ï¼šç¢ºä¿ç«™é»é †åºåœ¨åœ°ç†ä¸Šæ˜¯é€£è²«çš„"""
    if not stations: return []
    route = [start_node, end_node]
    
    # å»ºç«‹å‰¯æœ¬ä»¥å…æ›´å‹•åŸå§‹è³‡æ–™
    remaining = list(stations)
    
    # æ¯æ¬¡æŒ‘é¸ä¸€å€‹ç«™é»ï¼Œæ’å…¥åˆ°å¢åŠ é‡Œç¨‹æœ€å°çš„ä½ç½®
    # æ³¨æ„ï¼šé€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œç›´æ¥æŒ‰é †åºæ’å…¥ï¼Œè‹¥è¦æ›´æº–ç¢ºå¯å…ˆç®—æ‰€æœ‰ç«™é»
    for s in remaining:
        best_inc = float('inf')
        insert_idx = 1
        for i in range(len(route) - 1):
            d1 = fast_dist(route[i], s)
            d2 = fast_dist(s, route[i+1])
            d_orig = fast_dist(route[i], route[i+1])
            inc = d1 + d2 - d_orig
            if inc < best_inc:
                best_inc = inc
                insert_idx = i + 1
        route.insert(insert_idx, s)
    
    # å›å‚³æ’é™¤æ‰ A, B çš„ç«™é»åºåˆ—
    return route[1:-1]


def auto_optimize(event=None):
    try:
        # 1. è®€å– UI åƒæ•¸
        w1 = float(document.querySelector("#w1").value)
        w2 = float(document.querySelector("#w2").value)
        s_cost = float(document.querySelector("#s-cost").value)
        c_bus = float(document.querySelector("#c-bus").value)
        
        # 2. å¼·å¥çš„ç‰†å£è§£æ (è§£æ±º ',' å ±éŒ¯å•é¡Œ)
        raw_walls = window.wallsArray.to_py()
        walls = set()
        for w in raw_walls:
            try:
                # åˆ¤æ–· w æ˜¯å¦ç‚ºå¯è¿­ä»£å°è±¡ä¸”é•·åº¦è‡³å°‘ç‚º 2
                if hasattr(w, '__getitem__') and len(w) >= 2:
                    walls.add((int(w[0]), int(w[1])))
                # å¦‚æœ w æœ¬èº«æ˜¯å€‹é€—è™Ÿå­—ä¸²æˆ–é«’è³‡æ–™ï¼Œé€™è£¡æœƒè¢« skip
            except (ValueError, TypeError):
                continue

        ps = window.passengers.to_py()
        if not ps:
            document.querySelector("#py-output").innerText = "æé†’ï¼šåœ°åœ–ä¸Šæ²’æœ‰ä¹˜å®¢ã€‚"
            return

        # --- [1. å»ºç«‹åˆå§‹å€™é¸é»æ¸…å–®] ---
        candidates_raw = []

        # A. ä¹˜å®¢é» (éœ€é€£é€š)
        for p in ps:
            if is_reachable(p, walls):
                candidates_raw.append({'x': int(p['x']), 'y': int(p['y'])})

        # B. K-Means èšé¡ä¸­å¿ƒ
        # å˜—è©¦ä¸åŒçš„ç¾¤çµ„æ•¸é‡ï¼Œé€™å¯ä»¥æ‰¾åˆ°ã€Œå¤šå€‹ä¹˜å®¢çš„ä¸­é–“é»ã€
        max_k = min(len(ps), 5)
        for k in range(2, max_k + 1):
            centers = simple_kmeans(ps, k)
            for c in centers:
                cx, cy = int(c['x']), int(c['y'])
                
                # é€™æ˜¯é—œéµä¿®æ­£ï¼šå¦‚æœä¸­å¿ƒé»ä¸åˆæ³•ï¼Œé€²è¡Œã€Œèºæ—‹æœå°‹ã€æ‰¾åˆ°æœ€è¿‘çš„åˆæ³•ç©ºåœ°
                if not is_reachable({'x': cx, 'y': cy}, walls):
                    found_valid = False
                    # æ“´å¤§æœå°‹ç¯„åœåˆ°åŠå¾‘ 2 (5x5 å€åŸŸ)
                    for r in range(1, 3): 
                        for dx in range(-r, r + 1):
                            for dy in range(-r, r + 1):
                                test_c = {'x': cx + dx, 'y': cy + dy}
                                if is_reachable(test_c, walls):
                                    candidates_raw.append(test_c)
                                    found_valid = True
                                    break
                            if found_valid: break
                        if found_valid: break
                    # å¦‚æœ 5x5 éƒ½æ‰¾ä¸åˆ°åˆæ³•é»ï¼Œä»£è¡¨é€™å€å…¨æ˜¯ç‰†ï¼Œç›´æ¥æ”¾æ£„é€™å€‹ä¸­å¿ƒé»
                else:
                    candidates_raw.append({'x': cx, 'y': cy})

        # --- [2. ç§»é™¤é‡è¤‡çš„å€™é¸é»] ---
        unique_candidates = []
        seen = set()
        for c in candidates_raw:
            pos = (int(c['x']), int(c['y']))
            if pos not in seen:
                unique_candidates.append(c)
                seen.add(pos)

        # --- [3. åŸ·è¡Œè²ªå©ªé¸å€] ---
        current_ss = [] 
        best_cost = get_total_cost(current_ss, ps, walls, w1, w2, s_cost, c_bus)
        
        print(f"å€™é¸é»ç¸½æ•¸: {len(unique_candidates)}")
        START_A = {'x': 1, 'y': 1}
        END_B = {'x': 18, 'y': 18}

        while True:
            best_candidate = None
            for cand in unique_candidates:
                if any(s['x'] == cand['x'] and s['y'] == cand['y'] for s in current_ss):
                    continue
                
                # --- é—œéµä¿®æ­£é» ---
                # ä¸è¦ç›´æ¥åŠ åœ¨æœ€å¾Œï¼Œè€Œæ˜¯å…ˆæ‰¾å‡ºã€Œå¦‚æœåŠ å…¥é€™å€‹é»ï¼Œæœ€é †è·¯çš„é †åºæ˜¯ä»€éº¼ã€
                temp_list = current_ss + [cand]
                sorted_test_ss = sort_stations_insertion(START_A, END_B, temp_list)
                
                # ç”¨æ’åºå¾Œçš„é †åºè¨ˆç®—æˆæœ¬
                test_cost = get_total_cost(sorted_test_ss, ps, walls, w1, w2, s_cost, c_bus)
                
                if test_cost < best_cost:
                    best_cost = test_cost
                    best_candidate = cand
            
            if best_candidate:
                current_ss.append(best_candidate)
                # ç‚ºäº†ä¸‹ä¸€æ¬¡å¾ªç’°ï¼Œé€™è£¡ä¹Ÿå¯ä»¥ä¿æŒ current_ss æ˜¯æ’åºéçš„ï¼Œæˆ–è€…ä¸æ’ä¹Ÿå¯ä»¥ï¼Œ
                # å› ç‚ºå¾ªç’°é–‹é ­æœƒé‡æ–°è·‘ sort_stations_insertion
                current_ss = sort_stations_insertion(START_A, END_B, current_ss)
                print(f"æ–°å¢å„ªåŒ–ç«™é»: ({best_candidate['x']}, {best_candidate['y']})")
            else:
                break 

        # æœ€çµ‚è¼¸å‡ºå‰å†ç¢ºä¿ä¸€æ¬¡é †åº
        final_ss = sort_stations_insertion(START_A, END_B, current_ss)
        window.updateStationsFromPy(final_ss)
        run_optimization()

    except Exception as e:
        import traceback
        document.querySelector("#py-output").innerText = f"å„ªåŒ–å¤±æ•—: {e}\n{traceback.format_exc()}"


window.autoOptimize = auto_optimize
window.runOptimization = run_optimization
document.querySelector("#pyscript-loading").style.display = "none"
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å…¬è»Šè·¯å¾‘è¦åŠƒç³»çµ±</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.1.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f0f2f5; margin: 0; padding: 20px; }
        .main-container { display: flex; gap: 20px; width: 1000px; height: 620px; }
        /* å›ºå®šç•«å¸ƒå°ºå¯¸ï¼Œé˜²æ­¢è®Šå½¢ */
        #mapCanvas { background: white; border: 2px solid #333; width: 600px; height: 600px; flex-shrink: 0; }
        .panel { flex: 1; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto; }
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button { padding: 10px; cursor: pointer; border: 1px solid #ccc; background: #eee; border-radius: 4px; font-weight: bold; }
        button.active { background: #3498db; color: white; }
        #btn-run { background: #27ae60; color: white; grid-column: span 2; margin-top: 10px; border: none; }
        .result-box { margin-top: 15px; background: #2c3e50; color: #fff; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; font-size: 13px; }
    </style>
</head>
<body>
    <!-- <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <div id="technical-report" style="padding: 40px; background: #fff; border-bottom: 4px solid #34495e; font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;">
        <h1 style="text-align: center; color: #2c3e50; font-size: 2em; margin-bottom: 10px;">é¡Œç›®äºŒï¼šå…¬è»Šè·¯ç·šèˆ‡ç«™é»è¨­ç½®è¦åŠƒ</h1>

        <div style="max-width: 1100px; margin: 0 auto;">
            
        <section style="margin-bottom: 40px; background: #fdfdfd; padding: 25px; border-radius: 12px; border: 1px solid #eee;">
            <h2 style="color: #2980b9; border-left: 6px solid #2980b9; padding-left: 15px; margin-bottom: 20px;">(1). å•é¡Œå»ºæ¨¡ï¼šåœ–è«–èˆ‡æ‹‰æ ¼æœ—æ—¥æœ€ä½³åŒ–</h2>
            <p>æœ¬ç³»çµ±å°‡å•é¡Œå»ºæ¨¡ç‚ºæœ€å°åŒ–<b>æ‹‰æ ¼æœ—æ—¥å‡½æ•¸ (Lagrangian Function)</b> \(L\)ï¼Œç”¨ä»¥å¹³è¡¡ç‡Ÿé‹æ”¯å‡ºèˆ‡æœå‹™å“è³ªï¼š</p>
            
            <div style="background: #fff; padding: 20px; border-radius: 10px; text-align: center; margin: 25px 0; font-size: 1.3em; border: 2px solid #3498db; color: #2c3e50;">
                $$L = w_1 \cdot (n \cdot S_{cost} + Dist_{bus} \cdot C_{bus}) + w_2 \cdot \sum dist(p_i, s_{nearest})$$
            </div>

            <p>å…¬å¼å„é …è®Šæ•¸èˆ‡å­å•é¡Œä¹‹å°æ‡‰å¦‚ä¸‹ï¼š</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 20px;">
                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #e67e22;">
                    <h4 style="margin-top: 0; color: #d35400;">å•é¡Œ 1ï¼šç‡Ÿé‹æˆæœ¬</h4>
                    <p>å°æ‡‰å…¬å¼ä¸­çš„å‰é … \((n \cdot S_{cost} + Dist_{bus} \cdot C_{bus})\)ï¼š</p>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        <li><b>\(n\)</b>ï¼šé è¨ˆè¨­ç½®çš„ä¸­ç¹¼ç«™é»ç¸½æ•¸ã€‚</li>
                        <li><b>\(S_{cost}\)</b>ï¼šå–®ä¸€ç«™é»çš„å›ºå®šå»ºè¨­èˆ‡ç¶­è­·æˆæœ¬ã€‚</li>
                        <li><b>\(Dist_{bus}\)</b>ï¼šå…¬è»Šå¾èµ·é» A ç¶“ç”±æ‰€æœ‰ç«™é»è‡³çµ‚é» B çš„ç¸½è¡Œé§›é‡Œç¨‹ã€‚</li>
                        <li><b>\(C_{bus}\)</b>ï¼šå…¬è»Šæ¯å–®ä½è·é›¢çš„ç‡Ÿé‹æˆæœ¬ã€‚</li>
                    </ul>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #e67e22;">
                    <h4 style="margin-top: 0; color: #d35400;">å•é¡Œ 2ï¼šè¡Œäººä¾¿æ·æˆæœ¬</h4>
                    <p>å°æ‡‰å…¬å¼ä¸­çš„å¾Œé … \(\sum dist(p_i, s_{nearest})\)ï¼š</p>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        <li><b>\(p_i\)</b>ï¼šç¬¬ \(i\) ä½ä¹˜å®¢çš„åº§æ¨™ä½ç½®ã€‚</li>
                        <li><b>\(s_{nearest}\)</b>ï¼šè·é›¢è©²ä¹˜å®¢æœ€è¿‘çš„å…¬è»Šç«™é»åº§æ¨™ã€‚</li>
                        <li><b>\(dist\)</b>ï¼šå…©é»é–“çš„ <b>\(L_2\) è·é›¢</b>ã€‚ç¸½å’Œä»£è¡¨æ‰€æœ‰ä¹˜å®¢æ­¥è¡Œè² æ“”ã€‚</li>
                        <li><b>\(w_1, w_2\)</b>ï¼šä»£è¡¨æ”¿åºœç‡Ÿé‹èˆ‡æ°‘çœ¾ä¾¿æ·é–“çš„æ¬Šé‡å„ªå…ˆé †åºã€‚</li>
                    </ul>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <h4 style="margin-top: 0; color: #27ae60;">å•é¡Œ 3ï¼šé¿éšœæœ€çŸ­è·¯å¾‘ (A* Search)</h4>
                    <p>è€ƒé‡ç³»çµ±æ•ˆèƒ½èˆ‡è¨ˆç®—æ•ˆç‡ï¼Œæˆ‘å€‘å°‡å…¬è»Šç§»å‹•è·¯å¾‘é™åˆ¶æ–¼ç¶²æ ¼å…§çš„ <b>8 å€‹é›¢æ•£æ–¹å‘</b>ã€‚æ­¤è¨­è¨ˆçš„ä¸»è¦ç›®çš„æ˜¯ç‚ºäº†ï¼š</p>
                    <ul style="font-size: 0.9em; padding-left: 20px;">
                        <li><b>é™åˆ¶æœå°‹ç©ºé–“</b>ï¼šå°‡åˆ†æ”¯å› å­æ§åˆ¶åœ¨ \(k=8\)ï¼Œé¿å…é€£çºŒç©ºé–“ä¸‹çš„è¨ˆç®—çˆ†ç‚¸ï¼Œç¢ºä¿å³æ™‚åæ‡‰ã€‚</li>
                        <li><b>å•Ÿç™¼å¼å‡½æ•¸æ‡‰ç”¨</b>ï¼šæ¡ç”¨ Octile è·é›¢é ä¼°å‰©é¤˜è·¯ç¨‹æˆæœ¬ã€‚</li>
                    </ul>
                    <div style="background: #f4f4f4; padding: 10px; font-size: 0.85em; margin: 5px 0;">
                        \(H = (dx + dy) + (1.414 - 2) \cdot \min(dx, dy)\)
                    </div>
                    <p style="font-size: 0.85em;"><small><b>è¨»ï¼š</b>æ­¤å‡½æ•¸å…·å‚™ã€Œå®¹è¨±æ€§ã€ï¼Œèƒ½ç¢ºä¿åœ¨é›¢æ•£è·¯ç¶²é™åˆ¶ä¸‹ï¼Œæ±‚å¾—ç‡Ÿé‹æˆæœ¬ \(Dist_{bus}\) çš„ç†è«–æœ€ä½³è§£ã€‚</small></p>
                </div>

                <div style="background: #fff; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                    <h4 style="margin-top: 0; color: #27ae60;">å•é¡Œ 4ï¼šæœ€ä½³ç«™é»ä½ˆç½®</h4>
                    <p>é€™æ˜¯ä¸€å€‹å‹•æ…‹æ±ºç­–å•é¡Œã€‚æˆ‘å€‘éœ€åœ¨ç¦å€é™åˆ¶ä¸‹ï¼Œé€éæ¼”ç®—æ³•æ‰¾åˆ°ä¸€çµ„å€™é¸åº§æ¨™é›†åˆ \(\{s_1, s_2, ..., s_n\}\)ï¼Œä½¿å‡½æ•¸ \(L\) é”åˆ°æœ€å°å€¼ã€‚æ­¤éç¨‹éœ€åŒæ™‚è€ƒæ…®è·¯å¾‘é€£é€šæ€§èˆ‡ä¹˜å®¢è¦†è“‹ç‡ã€‚</p>
                </div>
            </div>
        </section>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 40px 0;">

        <section style="margin-top: 40px; background: #fdfdfd; padding: 25px; border-radius: 12px; border: 1px solid #eee;">
            <h2 style="color: #2980b9; border-left: 6px solid #2980b9; padding-left: 15px; margin-bottom: 20px;">(2). æœ€ä½³åŒ–ç«™é»ä½ˆç½®ï¼šæœå°‹ç©ºé–“èˆ‡ç­–ç•¥æ¯”è¼ƒ</h2>
            
            <p>åœ¨å·²çŸ¥<b>ç¦å€é™åˆ¶</b>èˆ‡<b>è¡Œäººåº§æ¨™</b>çš„æƒ…æ³ä¸‹ï¼Œæœå°‹æœ€ä½³ç«™é»ä½ˆç½®èˆ‡ç«™é»é †åºæ˜¯ä¸€å€‹é«˜åº¦è¤‡é›œçš„æœ€ä½³åŒ–å•é¡Œã€‚æˆ‘å€‘çš„ç›®æ¨™æ˜¯åœ¨å¯æ¥å—çš„æ™‚é–“å…§ï¼Œæ‰¾å‡ºèƒ½ä½¿æˆæœ¬å‡½æ•¸ \(L\) é”åˆ°å±€éƒ¨æœ€ä½³æˆ–å…¨åŸŸæœ€ä½³çš„ç«™é»çµ„åˆã€‚</p>

            <div style="background: #fff; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #e9ecef;">
                <h4 style="margin-top: 0; color: #34495e;">æœå°‹ç©ºé–“çš„è½‰åŒ–</h4>
                <p style="font-size: 0.95em;">
                    é›–ç„¶æˆ‘å€‘å¯ä»¥å°‡æ­¤å•é¡Œè¦–ç‚ºä¸€å€‹å…¨åœ°åœ–çš„<b>çª®èˆ‰å•é¡Œ</b>ï¼Œä½†å…¶è¨ˆç®—è¤‡é›œåº¦æœƒéš¨åœ°åœ–å¤§å°å‘ˆå¹¾ä½•å€æ•¸å¢åŠ ã€‚
                    ç‚ºäº†æ•ˆèƒ½è€ƒé‡ï¼Œç³»çµ±å°‡æœå°‹ç©ºé–“é™åˆ¶åœ¨ä¸€å€‹å…·å‚™é«˜æ½›åŠ›çš„<b>ç«™é»å€™é¸æ± </b>å…§ï¼š
                </p>
                <ul style="font-size: 0.9em; line-height: 1.8;">
                    <li><b>K-Means ç¾¤èšä¸­å¿ƒ</b>ï¼šé‡å°è¡Œäººé€²è¡Œåˆ†ç¾¤ï¼Œæ‰¾åˆ°èƒ½ä»£è¡¨å„è‡ªäººç¾¤çš„å¹³å‡è·é›¢æœ€è¿‘çš„åº§æ¨™ã€‚</li>
                    <li><b>è¡Œäººè‡ªèº«åº§æ¨™</b>ï¼šç¢ºä¿"æ­¥è¡Œè·é›¢æœ€å°åŒ–"çš„æ½›åœ¨ç«™é»ä½ç½®ã€‚</li>
                </ul>
                <p style="font-size: 0.95em;">
                    <b>è·¯å¾‘ä¸€è‡´æ€§æœ€ä½³åŒ–ï¼š</b> 
                    æ‡‰æ³¨æ„çš„æ˜¯ï¼Œæ–°æ’å…¥çš„å…¬è»Šç«™é»å¿…é ˆç¬¦åˆ"å¾ A åˆ° B æ—¢æœ‰è·¯ç·šä¸­ï¼Œè·é›¢æ’å…¥é»é‚Šéš›æˆæœ¬æœ€å°çš„å…©å€‹ç¯€é»ä¸­é–“"ï¼Œ
                    æ‰ä¸æœƒå°è‡´è·¯å¾‘éœ‡ç›ªï¼ˆä¾‹å¦‚ï¼šåœ¨æ²³æµå…©å²¸å¤šæ¬¡å¾€è¿”éæ²³ï¼‰ï¼Œç¢ºä¿ç‡Ÿé‹é‡Œç¨‹çš„æœ€ä½³åŒ–ã€‚
                </p>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-top: 25px; background: white; font-size: 0.95em; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                <thead>
                    <tr style="background: #34495e; color: white;">
                        <th style="padding: 12px; border: 1px solid #ddd; width: 25%;">æœå°‹ç­–ç•¥</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">å„ªé»</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">ç¼ºé»</th>
                        <th style="padding: 12px; border: 1px solid #ddd;">é©ç”¨æƒ…å¢ƒ</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #c0392b;">å…¨åœ°åœ–çª®èˆ‰<br>(Exhaustive Search)</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">èƒ½ä¿è­‰æ‰¾åˆ°<b>å…¨åŸŸæœ€ä½³è§£</b>ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">æœå°‹æ™‚é–“æ¥µé•·ï¼Œç„¡æ³•åœ¨å³æ™‚äº’å‹•ç³»çµ±ä¸­ä½¿ç”¨ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">åœ°åœ–æ¥µå°æˆ–éœæ…‹é å…ˆè¦åŠƒã€‚</td>
                    </tr>
                    <tr style="background: #f9f9f9;">
                        <td style="padding: 12px; border: 1px solid #ddd; font-weight: bold; color: #27ae60;">å•Ÿç™¼å¼è²ªå©ªæ³•<br>(Heuristic Greedy)</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">é‡å° [K-Meansã€è¡Œäººåº§æ¨™] é€²è¡Œç¯©é¸ï¼Œé‹ç®—æ¥µå¿«ä¸”çµæœæ¥è¿‘æœ€ä½³è§£ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;">å¯èƒ½é™·å…¥å±€éƒ¨æœ€ä½³è§£ã€‚</td>
                        <td style="padding: 12px; border: 1px solid #ddd;"><b>å³æ™‚æ±ºç­–æ”¯æ´ã€å‹•æ…‹ä¹˜å®¢è®Šæ›´ã€‚</b></td>
                    </tr>
                </tbody>
            </table>
            
            <p style="margin-top: 20px; font-size: 0.9em; background: #fff8e1; padding: 10px; border-left: 5px solid #ffc107; border-radius: 4px;">
                <b>ç³»çµ±æœ€çµ‚æ¡ç”¨ï¼š</b> å•Ÿç™¼å¼è²ªå©ªæœå°‹ã€‚é€éå°‡æœå°‹ç¯„åœèšç„¦æ–¼é—œéµå€™é¸åº§æ¨™ï¼Œæˆ‘å€‘èƒ½åœ¨çŸ­æ™‚é–“å…§è¨ˆç®—å‡ºå…¼é¡§å»ºç½®æˆæœ¬ \(w_1\) èˆ‡æœå‹™å“è³ª \(w_2\) çš„ç«™é»ä½ˆç½®ã€‚
            </p>
        </section>

        <section style="margin-top: 40px; background: #fff; padding: 25px; border-radius: 12px; border: 1px solid #e1e8ed;">
            <h2 style="color: #2980b9; border-left: 6px solid #2980b9; padding-left: 15px; margin-bottom: 20px;">(3). è·¯å¾‘ç”ŸæˆæŠ€è¡“ç´°ç¯€ï¼šOctile A* æ¼”ç®—æ³•</h2>

            <p>è·¯å¾‘ç”Ÿæˆæ¨¡çµ„è² è²¬åœ¨èµ·é»ã€å„ç«™é»èˆ‡çµ‚é»ä¹‹é–“å»ºç«‹åˆæ³•çš„ç‰©ç†é€£ç·šã€‚ç³»çµ±çš„æ ¸å¿ƒå¼•æ“æ˜¯ A* æ¼”ç®—æ³•ï¼Œä¸¦é‡å°ç¶²æ ¼åœ°åœ–é€²è¡Œäº†æœ€ä½³åŒ–ã€‚</p>

            <div style="margin-bottom: 25px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">1. æ ¸å¿ƒæ¼”ç®—æ³•ï¼šA-Star</h4>
                <p style="font-size: 0.92em; line-height: 1.6;">
                    ç³»çµ±æ¡ç”¨ A* æ¼”ç®—æ³•ä½œç‚ºè·¯å¾‘è¦åŠƒå¼•æ“ã€‚é€éå•Ÿç™¼å¼ä¼°è¨ˆå‡½æ•¸ï¼ˆHeuristicï¼‰å¼•å°æœå°‹ï¼Œç¢ºä¿å…¬è»Šèƒ½å¾èµ·é» A ç¶“ç”±å„å€‹å„ªåŒ–ç«™é»åˆ°é”çµ‚é» Bã€‚è©²æ¼”ç®—æ³•é€éç¶­è­·ä¸€å€‹å„ªå…ˆéšŠåˆ—ï¼Œå„ªå…ˆæ¢ç´¢ç¸½é ä¼°æˆæœ¬ \( f(n) = g(n) + h(n) \) æœ€å°çš„ç¯€é»ã€‚
                </p>
            </div>

            <div style="margin-bottom: 25px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">2. ç§»å‹•è¦å‰‡ï¼šOctile Distance (å…«å‘ç§»å‹•é™åˆ¶)</h4>
                <p style="font-size: 0.92em; line-height: 1.6; margin-left: 5px;">
                    ç‚ºäº†æ¨¡æ“¬çœŸå¯¦çš„é“è·¯è½‰å‘ï¼Œæˆ‘å€‘ä¸ä½¿ç”¨å››æ–¹å‘ç§»å‹•ï¼ˆæ›¼å“ˆé “è·é›¢ï¼‰ï¼Œæ¡ç”¨ <b>Octile è·é›¢</b> è¦ç¯„ï¼š
                </p>
                <ul style="font-size: 0.9em; line-height: 1.8; margin-left: 5px;">
                    <li><b>ç§»å‹•æ¬Šé‡</b>ï¼šæ°´å¹³èˆ‡å‚ç›´ç§»å‹•æˆæœ¬ç‚º \( 1.0 \)ï¼Œå°è§’ç·šï¼ˆ45åº¦è§’ï¼‰ç§»å‹•æˆæœ¬ç‚º \( \sqrt{2} \approx 1.414 \)ã€‚</li>
                    <li><b>æ•ˆæœ</b>ï¼šé€™ä½¿å¾—è·¯å¾‘è¦–è¦ºä¸Šä¸å†æ˜¯åƒµç¡¬çš„ 90 åº¦è½‰å½ï¼Œè€Œæ˜¯èƒ½ä»¥æ–œå‘ç©¿æ¢­æ–¼å»ºç¯‰ç‰©é–“ï¼Œæ›´è²¼è¿‘ç¾å¯¦é“è·¯æ¨£æ…‹ã€‚</li>
                </ul>
            </div>

            <div style="margin-bottom: 10px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">3. éšœç¤™ç‰©é¿è®“èˆ‡é€£é€šæ€§</h4>
                <p style="font-size: 0.92em; line-height: 1.6;">
                    æ¼”ç®—æ³•åœ¨æœå°‹éç¨‹ä¸­æœƒå³æ™‚æ¯”å° <b>wallsSet</b> æ•¸æ“šã€‚æ¯ç•¶æœå°‹åˆ°æ–°ç¯€é»æ™‚ï¼Œç³»çµ±æœƒç«‹å³æª¢æŸ¥è©²åº§æ¨™æ˜¯å¦å±¬æ–¼ç¦å€ï¼š
                </p>
                <div style="background: #2d3436; color: #fab1a0; padding: 12px; font-family: 'Courier New', monospace; font-size: 0.85em; border-radius: 5px; margin: 10px 0;">
                    if (wallsSet.has(`${nextX},${nextY}`)) continue; // ç«‹å³æ¨æ£„ç‰†å…§è·¯å¾‘
                </div>
                <p style="font-size: 0.92em;">
                    é€™ç¢ºä¿äº†ç”Ÿæˆçš„è·¯å¾‘çµ•å°ä¸æœƒé‡ç–Šæ–¼ä»»ä½•ç¦å€åº§æ¨™ã€‚åœ¨ <b>Toy Demo</b> çš„æ²³æµå ´æ™¯ä¸­ï¼Œæ¼”ç®—æ³•æœƒè‡ªå‹•é–å®šå”¯ä¸€åˆæ³•çš„æ©‹æ¨‘ç¯€é» <b>(10, 10)</b> ä½œç‚ºè·¨å€è·¯å¾‘çš„å¿…ç¶“ä¹‹è™•ï¼Œå±•ç¾äº†æ¼”ç®—æ³•çš„ç’°å¢ƒæ„ŸçŸ¥èˆ‡è¦åŠƒèƒ½åŠ›ã€‚
                </p>
                
            </div>
            <div style="margin-bottom: 10px;">
                <h4 style="color: #34495e; margin-bottom: 10px;">4. å¤šç«™é»åºåˆ—ç”Ÿæˆï¼šå¾ç©ºè·¯å¾‘åˆ°å‹•æ…‹æ’å…¥</h4>
                <p style="font-size: 0.92em; line-height: 1.6; margin-left: 5px;">
                    è·¯å¾‘ç”Ÿæˆä¸¦éä¸€æ¬¡æ€§å®Œæˆï¼Œè€Œæ˜¯éš¨å„ªåŒ–éç¨‹å¾"ç©ºç™½è·¯å¾‘ == [A,B]"é€æ­¥æ¼”é€²ï¼š
                </p>
                <div style="background: #f0f4f8; padding: 20px; border-radius: 8px; border-left: 5px solid #27ae60; margin-left: 5px; margin-top: 10px;">
                    <ul style="font-size: 0.9em; line-height: 1.8; margin: 0; padding-left: 20px;">
                        <li><b>åˆå§‹åŒ–éšæ®µï¼š</b> æ­¤æ™‚ç«™é»æ¸…å–®ç‚ºç©ºï¼Œç³»çµ±å…ˆå»ºç«‹åŸºç¤ <b>[A] â†’ [B]</b> è»Œè·¡ä½œç‚ºåŸºæº–æˆæœ¬ã€‚</li>
                        <li><b>é€ä¸€å€™é¸è©•ä¼°ï¼š</b> é¸å®šä¸€å€‹å…·å‚™æ½›åŠ›çš„å€™é¸é» \( S \) æ™‚ï¼Œç³»çµ±æœƒæƒæç•¶å‰åºåˆ—ä¸­æ‰€æœ‰çš„ã€Œè·¯æ®µé–“éš™ã€ã€‚</li>
                        <li><b>åŸ·è¡Œæœ€çœæˆæœ¬æ’å…¥ï¼š</b> 
                            é€éå…¬å¼ \( \Delta Dist = Dist(N_i, S) + Dist(S, N_{i+1}) - Dist(N_i, N_{i+1}) \)ï¼Œ
                            å°‡è©²å€™é¸é»ç½®æ–¼ <b>å¢åŠ æˆæœ¬æœ€å°</b> çš„ä½ç½®ï¼Œç¢ºä¿åœ°ç†é€£çºŒæ€§ã€‚
                        </li>
                        <li><b>éè¿´å¢é•·ï¼š</b> æ¯æˆåŠŸæ’å…¥ä¸€å€‹é»ï¼Œä¾¿å½¢æˆæ–°çš„è·¯å¾‘åŸºæº–ã€‚æ­¤éç¨‹ä¸æ–·é‡è¤‡ï¼Œç›´åˆ°æ–°å¢ä»»ä½•å€™é¸é»éƒ½ç„¡æ³•å†é™ä½ç¸½æˆæœ¬å‡½æ•¸ \( L \) ç‚ºæ­¢ã€‚</li>
                    </ul>
                </div>
                
                <p style="font-size: 0.85em; color: #c0392b; margin-top: 10px; margin-left: 5px;">
                    <i>â€» è¨»ï¼šæ­¤å‹•æ…‹æ’å…¥æ©Ÿåˆ¶æœ‰æ•ˆè§£æ±ºäº†å¤šç«™é»ç’°å¢ƒä¸‹ï¼Œå› æ’åºä¸ç•¶å°è‡´çš„ã€Œåè¦†éæ²³ã€æˆ–ã€Œå¤§å¹…ç¹è·¯ã€ç­‰éæœ€å„ªè§£å•é¡Œã€‚</i>
                </p>
            </div>


        </section>
            
        </div>
    </div>



    <h2 style="margin-bottom:10px;">ğŸšŒ å…¬è»Š LRP è¦åŠƒå·¥å…· (Hybrid Python)</h2>
    <div id="pyscript-loading" style="color:orange; font-weight:bold;">ç³»çµ±æ ¸å¿ƒè¼‰å…¥ä¸­...</div>

    <div class="main-container">
        <canvas id="mapCanvas" width="600" height="600"></canvas>

    <div class="panel">
        <div class="btn-group">
            <button onclick="setMode('wall')" id="btn-wall" class="active">ğŸš« ç¦å€</button>
            <button onclick="setMode('passenger')" id="btn-passenger">ğŸ‘¤ ä¹˜å®¢</button>
            <button onclick="setMode('station')" id="btn-station">ğŸš ç«™ç‰Œ</button>
            <button onclick="resetMap()" style="background:#e74c3c; color:white;">ğŸ—‘ï¸ æ¸…ç©º</button>
            <button id="btn-run" onclick="triggerOptimization()">ğŸš€ åŸ·è¡Œé‹ç®—</button>
            <button id="btn-auto" onclick="triggerAutoOptimize()" style="background:#9b59b6; color:white; grid-column: span 2; margin-top: 5px; border: none;">ğŸ¤– AI è‡ªå‹•é¸å€ (Lagrangian)</button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                ç‡Ÿé‹æ¬Šé‡ w1: <span id="w1-v" style="color: #27ae60; float: right;">1.0</span>
            </label>
            <input type="range" id="w1" min="0" max="10" step="0.5" value="1.0" oninput="updateWeights()" style="width: 100%; cursor: pointer;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                æ­¥è¡Œæ¬Šé‡ w2: <span id="w2-v" style="color: #3498db; float: right;">1.0</span>
            </label>
            <input type="range" id="w2" min="0" max="10" step="0.5" value="1.0" oninput="updateWeights()" style="width: 100%; cursor: pointer;">
        </div>

        <div style="margin-bottom: 15px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                ç«™ç‰Œè¨­ç½®æˆæœ¬ (S): <span id="s-cost-v" style="color: #e67e22; float: right;">10</span>
            </label>
            <input type="number" id="s-cost" value="10" min="0" step="1" oninput="updateWeights()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: bold; margin-bottom: 5px;">
                å…¬è»Šè¡Œèµ°æˆæœ¬ (C): <span id="c-bus-v" style="color: #7f8c8d; float: right;">1.0</span>
            </label>
            <input type="number" id="c-bus" value="1.0" min="0.1" step="0.1" oninput="updateWeights()" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;">
        </div>

        <div class="result-box" id="py-output">ç­‰å¾…æŒ‡ä»¤...</div>
    </div>

    </div>

<script>
    const canvas = document.getElementById('mapCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 30;
    
    window.wallsArray = [];
    window.passengers = [];
    window.stations = [];
    let mode = 'wall';
    let wallsSet = new Set();


    function setMode(m) {
        mode = m;
        document.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + m).classList.add('active');
    }

    canvas.addEventListener('mousedown', (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / (rect.width / 20));
        const y = Math.floor((e.clientY - rect.top) / (rect.height / 20));
        
        if (mode === 'wall') {
            const key = `${x},${y}`;
            if (wallsSet.has(key)) wallsSet.delete(key); else wallsSet.add(key);
            window.wallsArray = Array.from(wallsSet);
        } else if (mode === 'passenger') window.passengers.push({x, y});
        else if (mode === 'station') window.stations.push({x, y});
        drawBase();
    });

    function resetMap() {
        wallsSet.clear(); window.wallsArray=[]; window.passengers=[]; window.stations=[];
        drawBase();
    }

    function updateWeights() {
        document.getElementById('w1-v').innerText = document.getElementById('w1').value;
        document.getElementById('w2-v').innerText = document.getElementById('w2').value;
        document.getElementById('s-cost-v').innerText = document.getElementById('s-cost').value;
        document.getElementById('c-bus-v').innerText = document.getElementById('c-bus').value;
    }
    
    function triggerOptimization() {
        if (window.runOptimization) window.runOptimization();
    }
    function triggerAutoOptimize() {
        if (window.autoOptimize) {
            document.getElementById('py-output').innerText = "AI æ­£åœ¨è¨ˆç®—æœ€ä½³ç«™é»é…ç½®...";
            window.autoOptimize(); // å‘¼å« Python çš„å„ªåŒ–å‡½å¼
        }
    }

    // é€™å€‹å‡½å¼è®“ Python ç®—å®Œå¾Œï¼ŒæŠŠç«™é»ä½ç½®æ›´æ–°åˆ°åœ°åœ–ä¸Š
    window.updateStationsFromPy = function(newStationsProxy) {
        // å°‡ Python è³‡æ–™è½‰å› JS æ ¼å¼
        window.stations = Array.from(newStationsProxy).map(p => ({
            x: (typeof p.x !== 'undefined') ? p.x : p.get('x'),
            y: (typeof p.y !== 'undefined') ? p.y : p.get('y')
        }));
        drawBase(); // é‡æ–°ç•«åœ–ï¼Œè®“ç«™é»å‡ºç¾åœ¨ç•«é¢ä¸Š
    };
    

    function drawBase() {
        ctx.clearRect(0, 0, 600, 600);
        ctx.strokeStyle = '#eee';
        for(let i=0; i<20; i++) {
            for(let j=0; j<20; j++) {
                ctx.strokeRect(i*30, j*30, 30, 30);
                if(wallsSet.has(`${i},${j}`)) {
                    ctx.fillStyle = '#ff7675';
                    ctx.fillRect(i*30, j*30, 30, 30);
                }
            }
        }
        window.passengers.forEach(p => drawPoint(p.x, p.y, '#3498db', 'P'));
        window.stations.forEach((s,i) => drawPoint(s.x, s.y, '#2ecc71', 'S'+(i+1)));
        drawPoint(1, 1, 'gold', 'A'); drawPoint(18, 18, 'orange', 'B');
    }

    function drawPoint(x, y, color, label) {
        const cx = x * 30 + 15;
        const cy = y * 30 + 15;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰é‡ç–Š (é€éæ¨™ç±¤é–‹é ­åˆ¤æ–·)
        const isStation = label.startsWith('S');
        const isPassenger = label.startsWith('P');

        ctx.save();
        
        if (isStation) {
            // ç«™é»ç•«å¤§ä¸€é»ï¼Œç•¶ä½œåº•åº§
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(cx, cy, 12, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // æ¨™ç±¤å¯«åœ¨ä¸Šæ–¹
            ctx.fillStyle = "black";
            ctx.font = "bold 10px Arial";
            ctx.textAlign = "center";
            ctx.fillText(label, cx, cy - 14);
        } 
        else if (isPassenger) {
            // ä¹˜å®¢ç•«å°ä¸€é»ï¼Œä¸¦åŠ ä¸Šé™°å½±/é‚Šæ¡†
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(cx, cy, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 1.5;
            ctx.stroke();
            
            // æ¨™ç±¤å¯«åœ¨ä¸‹æ–¹
            ctx.fillStyle = "#2980b9";
            ctx.font = "9px Arial";
            ctx.textAlign = "center";
            ctx.fillText(label, cx, cy + 18);
        } 
        else {
            // èµ·é»(A)èˆ‡çµ‚é»(B)ç¶­æŒåŸæ¨£
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(cx, cy, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "black";
            ctx.fillText(label, cx - 5, cy + 4);
        }
        
        ctx.restore();
    }
    
    // é—œéµä¿®æ­£ï¼šç¢ºä¿ path æ˜¯ç´” JS é™£åˆ—
    window.renderPath = function(pathProxy, color, isDashed) {
        // å¼·åˆ¶è½‰æ›ï¼šè™•ç† Python Proxy ç‰©ä»¶ï¼Œç¢ºä¿è½‰æˆç´” JS Array
        let rawPath = Array.from(pathProxy);
        let path = rawPath.map(p => {
            // å…¼å®¹è™•ç†ï¼šåŒæ™‚å˜—è©¦è®€å–å±¬æ€§èˆ‡å­—å…¸ key
            let x = (typeof p.x !== 'undefined') ? p.x : p.get('x');
            let y = (typeof p.y !== 'undefined') ? p.y : p.get('y');
            return { x: Number(x), y: Number(y) };
        });

        if (path.length < 2) return;

        ctx.save();
        ctx.beginPath();
        ctx.strokeStyle = color;
        ctx.lineWidth = isDashed ? 2 : 4;
        if (isDashed) ctx.setLineDash([5, 5]);
        
        // ç¹ªè£½è·¯å¾‘ä¸»é«”
        ctx.moveTo(path[0].x * 30 + 15, path[0].y * 30 + 15);
        for (let i = 1; i < path.length; i++) {
            ctx.lineTo(path[i].x * 30 + 15, path[i].y * 30 + 15);
        }
        ctx.stroke();

        // ç¹ªè£½ç®­é ­
        ctx.setLineDash([]);
        ctx.fillStyle = color;
        
        // éæ­·è·¯å¾‘ç•«ç®­é ­
        for (let i = 1; i < path.length; i++) {
            // å…¬è»Šå¯¦ç·š(æ©˜)ï¼šæ¯ä¸€æ ¼ä¸­é–“éƒ½ç•«ï¼›è¡Œäººè™›ç·š(è—)ï¼šåªåœ¨æœ€å¾Œä¸€æ ¼(ç«™é»è™•)ç•«
            if (!isDashed || i === path.length - 1) {
                drawArrowhead(path[i-1], path[i], color, isDashed ? 8 : 12);
            }
        }
        ctx.restore();
    };
    function drawArrowhead(from, to, color, size) {
        const tx = to.x * 30 + 15;
        const ty = to.y * 30 + 15;
        const fx = from.x * 30 + 15;
        const fy = from.y * 30 + 15;
        
        // è¨ˆç®—è§’åº¦
        const angle = Math.atan2(ty - fy, tx - fx);
        
        ctx.beginPath();
        ctx.moveTo(tx, ty); // ç®­é ­å°–ç«¯åœ¨ç›®æ¨™é»ä¸­å¿ƒ
        // ç¹ªè£½å…©ç¿¼
        ctx.lineTo(tx - size * Math.cos(angle - Math.PI/6), ty - size * Math.sin(angle - Math.PI/6));
        ctx.lineTo(tx - size * Math.cos(angle + Math.PI/6), ty - size * Math.sin(angle + Math.PI/6));
        ctx.closePath();
        ctx.fill();
    }
    window.onload = () => drawBase();

    function loadToyDemo() {
        console.log("æ­£åœ¨é‡ç½® Toy Demo...");
        
        // 1. å®Œå…¨æ¸…ç©ºç¾æœ‰æ•¸æ“š
        wallsSet.clear(); // å‹™å¿…æ¸…ç©º Setï¼Œå¦å‰‡èˆŠç‰†æœƒç•™è‘—
        window.wallsArray = [];
        window.passengers = [];
        window.stations = []; 

        // 2. åœ°å½¢å»ºè¨­ï¼šä¸­å¤®æ²³æµ
        for (let x = 0; x < 20; x++) {
            if (x !== 10) {
                wallsSet.add(`${x},10`); // åŒæ­¥æ›´æ–°åˆ° Set ä¾› drawBase ä½¿ç”¨
            }
        }

        // 3. åœ°å½¢å»ºè¨­ï¼šå³ä¸‹è§’ã€Œå°é–‰å¼ç¤¾å€ã€
        for (let x = 12; x <= 16; x++) {
                for (let y = 12; y <= 16; y++) {
                    // å¦‚æœæ˜¯å¤–æ¡†ä¸”ä¸æ˜¯é–€å£ (14,16)
                    if ((x === 12 || x === 16 || y === 12 || y === 16) && !(x === 14 && y === 16)) {
                        wallsSet.add(`${x},${y}`);
                    }
                }
            }
        // 4. åœ°å½¢å»ºè¨­ï¼šå·¦ä¸Šè§’ã€ŒåŠé–‹æ”¾å¼ç¤¾å€ã€
        const openWalls = [
            [3, 3], [4, 3], [6, 3], [7, 3], // Y=3 æ©«å‘æœ‰ç¼ºå£
            [3, 5], [5, 5], [7, 5],         // Y=5 éŒ¯è½åˆ†ä½ˆ
            [4, 7], [6, 7]                  // Y=7 å¯¬é¬†åˆ†ä½ˆ
        ];
        openWalls.forEach(w => wallsSet.add(`${w[0]},${w[1]}`));

        // 5. åŒæ­¥ wallsArray (è½‰æˆ Python èªè­˜çš„æ ¼å¼)
        window.wallsArray = Array.from(wallsSet);

        // 6. æ”¾ç½® 20 ä½è¡Œäºº
        const p = [];
        p.push({x: 2, y: 2}, {x: 5, y: 2}, {x: 8, y: 3}, {x: 15, y: 2}, {x: 18, y: 3});
        for(let i=0; i<8; i++) {
            p.push({x: 13 + (i%3), y: 13 + Math.floor(i/3)});
        }
        p.push({x: 4, y: 14}, {x: 5, y: 15}, {x: 2, y: 18}, {x: 8, y: 12}, {x: 12, y: 18}, {x: 8, y: 17}, {x: 15, y: 18});        window.passengers = p;

        // 7. æ›´æ–°ç•«é¢ï¼šä½ çš„ç¹ªåœ–å‡½æ•¸åç¨±æ˜¯ drawBase
        if(document.querySelector("#w1")) document.querySelector("#w1").value = 1.0;
        if(document.querySelector("#w2")) document.querySelector("#w2").value = 1.0;
        drawBase();
    }

    window.addEventListener('DOMContentLoaded', () => {
        // ç¨å¾®å»¶é²ç¢ºä¿ Pyodide æº–å‚™å°±ç·’
        setTimeout(() => {
            loadToyDemo();
            // ç¢ºä¿åŸ·è¡Œ drawBase
            if (typeof drawBase === 'function') {
                drawBase();
            }
        }, 500); 
    });

</script>

<script type="py">
from pyscript import window, document
import math

class AStar:
    def solve(self, start, end, walls):
        # ç¢ºä¿ start/end æ˜¯æ•´æ•¸
        sx, sy = int(round(start['x'])), int(round(start['y']))
        ex, ey = int(round(end['x'])), int(round(end['y']))
        
        open_set = [{'x': sx, 'y': sy}]
        came_from = {}
        g = {(sx, sy): 0}
        
        while open_set:
            curr = min(open_set, key=lambda n: g[(n['x'], n['y'])] + self.heuristic(n, {'x': ex, 'y': ey}))
            
            if curr['x'] == ex and curr['y'] == ey:
                res = []
                while (curr['x'], curr['y']) in came_from:
                    res.append(curr)
                    curr = came_from[(curr['x'], curr['y'])]
                res.append({'x': sx, 'y': sy})
                return res[::-1]
            
            open_set.remove(curr)
            
            # 8 æ–¹å‘
            directions = [
                (0, 1, 1), (0, -1, 1), (1, 0, 1), (-1, 0, 1),
                (1, 1, 1.414), (1, -1, 1.414), (-1, 1, 1.414), (-1, -1, 1.414)
            ]
            
            for dx, dy, cost in directions:
                nx, ny = int(curr['x'] + dx), int(curr['y'] + dy)
                
                # --- [é—œéµä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ Tuple æ¯”å°] ---
                if 0 <= nx < 20 and 0 <= ny < 20 and (nx, ny) not in walls:
                    # é¸é…ï¼šé˜²æ­¢æ–œå‘ç©¿éç‰†è§’ç¸«éš™ (å»ºè­°é–‹å•Ÿ)
                    if dx != 0 and dy != 0:
                        if (curr['x'] + dx, curr['y']) in walls and (curr['x'], curr['y'] + dy) in walls:
                            continue

                    new_g = g[(curr['x'], curr['y'])] + cost
                    if new_g < g.get((nx, ny), 9999):
                        came_from[(nx, ny)] = curr
                        g[(nx, ny)] = new_g
                        # æª¢æŸ¥æ˜¯å¦å·²åœ¨ open_set ä¸­ (æ¯”è¼ƒåº§æ¨™è€Œéç‰©ä»¶)
                        if not any(n['x'] == nx and n['y'] == ny for n in open_set):
                            open_set.append({'x': nx, 'y': ny})
                            
        return [{'x': sx, 'y': sy}, {'x': ex, 'y': ey}] # æ‰¾ä¸åˆ°è·¯å¾‘æ™‚å›å‚³ç›´ç·š

    def heuristic(self, a, b):
        dx = abs(a['x'] - b['x'])
        dy = abs(a['y'] - b['y'])
        return (dx + dy) + (1.414 - 2) * min(dx, dy)


def simple_kmeans(points, k, iterations=10):
    if not points or k <= 0: return []
    
    # 1. åˆå§‹ä¸­å¿ƒé»
    centers = [{'x': float(p['x']), 'y': float(p['y'])} for p in points[:k]]
    
    for _ in range(iterations):
        clusters = [[] for _ in range(k)]
        for p in points:
            px, py = float(p['x']), float(p['y'])
            dists = [math.sqrt((px - c['x'])**2 + (py - c['y'])**2) for c in centers]
            idx = dists.index(min(dists))
            clusters[idx].append(p)
        
        new_centers = []
        for i in range(k):
            if not clusters[i]: 
                new_centers.append(centers[i])
                continue
            avg_x = sum(float(p['x']) for p in clusters[i]) / len(clusters[i])
            avg_y = sum(float(p['y']) for p in clusters[i]) / len(clusters[i])
            
            # --- [é—œéµä¿®æ­£ï¼šæœ«å°¾å°é½Š] ---
            # å››æ¨äº”å…¥å¾Œè½‰ç‚º intï¼Œä¸¦ç¢ºä¿å‹åˆ¥æ˜¯èˆ‡ä¹˜å®¢é»ä¸€è‡´çš„ dictionary
            new_centers.append({
                'x': int(round(avg_x)), 
                'y': int(round(avg_y))
            })
        centers = new_centers
        
    return centers

def get_optimal_sequence(start_node, end_node, station_list):
    """
    ä½¿ç”¨ç°¡å–®çš„æ’å…¥å•Ÿç™¼å¼ (Insertion Heuristic) ç¢ºä¿ç«™é»é †åºåˆç†
    """
    optimized_route = [start_node, end_node]
    
    # å°‡ç«™é»ä¸€å€‹ä¸€å€‹æ’å…¥åˆ°æœ€é©åˆçš„ä½ç½®
    for s in station_list:
        best_increase = float('inf')
        best_index = 1
        
        for i in range(len(optimized_route) - 1):
            n1 = optimized_route[i]
            n2 = optimized_route[i+1]
            
            # è¨ˆç®—æ’å…¥è©²ç«™é»å¾Œå¢åŠ çš„é‡Œç¨‹
            # é€™è£¡å¯ä»¥ç›´æ¥ç”¨ Octile è·é›¢å¿«é€Ÿé ä¼°ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½è·‘ A*
            d1 = octile_distance(n1, s)
            d2 = octile_distance(s, n2)
            d_orig = octile_distance(n1, n2)
            
            increase = d1 + d2 - d_orig
            if increase < best_increase:
                best_increase = increase
                best_index = i + 1
        
        optimized_route.insert(best_index, s)
    
    return optimized_route # å›å‚³ [A, S_best1, S_best2, ..., B]

def run_optimization(event=None):
    try:
        raw_walls = window.wallsArray.to_py()
        walls = set()
        for w in raw_walls:
            try:
                if isinstance(w, str) and ',' in w:
                    # è™•ç†å­—ä¸²æ ¼å¼ '9,2' -> è½‰ç‚ºæ•´æ•¸ (9, 2)
                    parts = w.split(',')
                    walls.add((int(parts[0].strip()), int(parts[1].strip())))
                elif hasattr(w, '__getitem__') and len(w) >= 2:
                    # è™•ç†åˆ—è¡¨æ ¼å¼ [9, 2] -> è½‰ç‚ºæ•´æ•¸ (9, 2)
                    walls.add((int(w[0]), int(w[1])))
            except (ValueError, TypeError):
                continue
        print(f"DEBUG - ç‰†å£åº§æ¨™ç¯„ä¾‹: {list(walls)[:5]}")
        ps = window.passengers.to_py()
        ss = window.stations.to_py()
        
        w1 = float(document.querySelector("#w1").value)
        w2 = float(document.querySelector("#w2").value)
        s_cost_unit = float(document.querySelector("#s-cost").value)
        c_bus_unit = float(document.querySelector("#c-bus").value)
        
        window.drawBase()
        solver = AStar()
        
        # 1. è¡Œäººæˆæœ¬èˆ‡æ¸²æŸ“ (L2 è·é›¢)
        ped_total_d = 0
        all_nodes = ss + [{'x': 1, 'y': 1}, {'x': 18, 'y': 18}]
        for p in ps:
            closest_node = min(all_nodes, key=lambda n: math.sqrt((p['x']-n['x'])**2 + (p['y']-n['y'])**2))
            dist = math.sqrt((p['x']-closest_node['x'])**2 + (p['y']-closest_node['y'])**2)
            ped_total_d += dist
            window.renderPath([p, closest_node], "rgba(52, 152, 219, 0.6)", True)

        # 2. å…¬è»Šæˆæœ¬èˆ‡æ¸²æŸ“ (8æ–¹å‘è·¯å¾‘)
        route = [{'x': 1, 'y': 1}] + ss + [{'x': 18, 'y': 18}]
        bus_total_d = 0
        for i in range(len(route)-1):
            seg = solver.solve(route[i], route[i+1], walls)
            for j in range(len(seg)-1):
                dx, dy = abs(seg[j]['x']-seg[j+1]['x']), abs(seg[j]['y']-seg[j+1]['y'])
                bus_total_d += 1.4142 if (dx > 0 and dy > 0) else 1
            window.renderPath(seg, "#f39c12", False)

        # 3. å„é …åˆ†é …æˆæœ¬è¨ˆç®—
        station_total_cost = len(ss) * s_cost_unit  # ç«™ç‰Œæˆæœ¬
        bus_op_cost = w1 * bus_total_d * c_bus_unit # ç‡Ÿé‹æˆæœ¬
        ped_walk_cost = w2 * ped_total_d            # æ­¥è¡Œæˆæœ¬
        
        total_lagrangian = bus_op_cost + ped_walk_cost + station_total_cost
        
        # 4. æ ¼å¼åŒ–è¼¸å‡ºå ±å‘Š
        output =  "ã€ æˆæœ¬çµ±è¨ˆå ±å‘Š ã€‘\n"
        output += f"----------------------------\n"
        output += f"ğŸšŒ å…¬è»Šç¸½è·é›¢: {bus_total_d:.2f}\n"
        output += f"ğŸ’° ç‡Ÿé‹ç¸½æˆæœ¬: {bus_op_cost:.2f} (w1*dist*C)\n"
        output += f"----------------------------\n"
        output += f"ğŸš ç«™ç‰Œç¸½æ•¸é‡: {len(ss)} ç«™\n"
        output += f"ğŸ—ï¸ ç«™ç‰Œç¸½æˆæœ¬: {station_total_cost:.2f} (N*S)\n"
        output += f"----------------------------\n"
        output += f"ğŸš¶ è¡Œäººç¸½æ­¥è¡Œ: {ped_total_d:.2f}\n"
        output += f"ğŸ‘Ÿ æ­¥è¡Œç¸½æˆæœ¬: {ped_walk_cost:.2f} (w2*dist)\n"
        output += f"============================\n"
        output += f"ğŸš€ ç¸½æ‹‰æ ¼æœ—æ—¥æˆæœ¬: {total_lagrangian:.2f}"
        
        document.querySelector("#py-output").innerText = output
        
    except Exception as e:
        document.querySelector("#py-output").innerText = f"é‹ç®—éŒ¯èª¤: {e}"


def get_total_cost(stations, passengers, walls, w1, w2, s_cost, c_bus):
    solver = AStar()
    # 1. å…¬è»Šè·¯å¾‘ (èµ·é» -> æ‰€æœ‰ä¸­ç¹¼ç«™ -> çµ‚é»)
    route = [{'x': 1, 'y': 1}] + stations + [{'x': 18, 'y': 18}]
    bus_d = 0
    for i in range(len(route)-1):
        seg = solver.solve(route[i], route[i+1], walls)
        for j in range(len(seg)-1):
            dx = abs(seg[j]['x'] - seg[j+1]['x'])
            dy = abs(seg[j]['y'] - seg[j+1]['y'])
            # 8æ–¹å‘è·é›¢ç´¯åŠ 
            bus_d += 1.414 if (dx > 0 and dy > 0) else 1
            
    # 2. è¡Œäººæˆæœ¬ï¼šå°‡ [èµ·é», çµ‚é»] èˆ‡ [ç«™é»] åˆä½µè€ƒæ…®
    ped_d = 0
    # é—œéµï¼šé€™è£¡ç¢ºä¿äº†å³ä½¿ stations æ˜¯ç©ºçš„ï¼Œä¹Ÿæœ‰ç¯€é»å¯ä»¥è¨ˆç®—è·é›¢
    all_available_nodes = stations + [{'x': 1, 'y': 1}, {'x': 18, 'y': 18}]
    
    for p in passengers:
        # è¨ˆç®—ä¹˜å®¢åˆ°æœ€è¿‘ç¯€é»çš„ L2 è·é›¢
        dists = [math.sqrt((p['x']-n['x'])**2 + (p['y']-n['y'])**2) for n in all_available_nodes]
        ped_d += min(dists)
        
    return (w1 * bus_d * c_bus) + (w2 * ped_d) + (len(stations) * s_cost)


def is_reachable(p, walls):
    """
    ç²¾ç¢ºæª¢æŸ¥ï¼š1. æ˜¯å¦åœ¨ç‰†å…§ 2. æ˜¯å¦èƒ½é€£é€š
    """
    # ç¢ºä¿åº§æ¨™æ˜¯æ•´æ•¸
    tx, ty = int(p['x']), int(p['y'])
    
    # èª¿æŸ¥ï¼šåœ¨ Python ç«¯å°å‡ºåº§æ¨™ï¼Œè®“ä½ æª¢æŸ¥ X Y æ˜¯å¦åäº†
    print(f"æª¢æŸ¥ä¹˜å®¢ä½ç½®: x={tx}, y={ty}")
    
    # 1. ç‰©ç†æª¢æŸ¥ï¼šå¦‚æœæ˜¯ç‰†ï¼Œç›´æ¥å‰”é™¤
    # æ³¨æ„ï¼šé€™è£¡çš„ (tx, ty) å¿…é ˆèˆ‡ä½ ç•¶åˆå­˜å…¥ walls çš„é †åºå®Œå…¨ä¸€è‡´
    if (tx, ty) in walls:
        print(f"åˆ¤å®šçµæœ: é» ({tx}, {ty}) åœ¨ç‰†å…§ï¼Œå‰”é™¤ã€‚")
        return False
        
    # 2. é€£é€šæª¢æŸ¥
    solver = AStar()
    # èµ·é»å›ºå®šç‚º (1, 1)
    path = solver.solve({'x': 1, 'y': 1}, {'x': tx, 'y': ty}, walls)
    
    reachable = len(path) > 0 or (tx == 1 and ty == 1)
    if not reachable:
        print(f"åˆ¤å®šçµæœ: é» ({tx}, {ty}) æ˜¯å­¤å³¶ï¼Œå‰”é™¤ã€‚")
        
    return reachable    

def fast_dist(p1, p2):
    # æ”¯æ´å­—å…¸æ ¼å¼æˆ–å…ƒçµ„æ ¼å¼
    x1, y1 = (p1['x'], p1['y']) if isinstance(p1, dict) else (p1[0], p1[1])
    x2, y2 = (p2['x'], p2['y']) if isinstance(p2, dict) else (p2[0], p2[1])
    dx, dy = abs(x1 - x2), abs(y1 - y2)
    return (dx + dy) + (1.414 - 2) * min(dx, dy)

def sort_stations_insertion(start_node, end_node, stations):
    """æœ€çœæˆæœ¬æ’å…¥æ³•ï¼šç¢ºä¿ç«™é»é †åºåœ¨åœ°ç†ä¸Šæ˜¯é€£è²«çš„"""
    if not stations: return []
    route = [start_node, end_node]
    
    # å»ºç«‹å‰¯æœ¬ä»¥å…æ›´å‹•åŸå§‹è³‡æ–™
    remaining = list(stations)
    
    # æ¯æ¬¡æŒ‘é¸ä¸€å€‹ç«™é»ï¼Œæ’å…¥åˆ°å¢åŠ é‡Œç¨‹æœ€å°çš„ä½ç½®
    # æ³¨æ„ï¼šé€™è£¡ç‚ºäº†ç°¡åŒ–ï¼Œç›´æ¥æŒ‰é †åºæ’å…¥ï¼Œè‹¥è¦æ›´æº–ç¢ºå¯å…ˆç®—æ‰€æœ‰ç«™é»
    for s in remaining:
        best_inc = float('inf')
        insert_idx = 1
        for i in range(len(route) - 1):
            d1 = fast_dist(route[i], s)
            d2 = fast_dist(s, route[i+1])
            d_orig = fast_dist(route[i], route[i+1])
            inc = d1 + d2 - d_orig
            if inc < best_inc:
                best_inc = inc
                insert_idx = i + 1
        route.insert(insert_idx, s)
    
    # å›å‚³æ’é™¤æ‰ A, B çš„ç«™é»åºåˆ—
    return route[1:-1]


def auto_optimize(event=None):
    try:
        # 1. è®€å– UI åƒæ•¸
        w1 = float(document.querySelector("#w1").value)
        w2 = float(document.querySelector("#w2").value)
        s_cost = float(document.querySelector("#s-cost").value)
        c_bus = float(document.querySelector("#c-bus").value)
        
        # 2. å¼·å¥çš„ç‰†å£è§£æ (è§£æ±º ',' å ±éŒ¯å•é¡Œ)
        raw_walls = window.wallsArray.to_py()
        walls = set()
        for w in raw_walls:
            try:
                # åˆ¤æ–· w æ˜¯å¦ç‚ºå¯è¿­ä»£å°è±¡ä¸”é•·åº¦è‡³å°‘ç‚º 2
                if hasattr(w, '__getitem__') and len(w) >= 2:
                    walls.add((int(w[0]), int(w[1])))
                # å¦‚æœ w æœ¬èº«æ˜¯å€‹é€—è™Ÿå­—ä¸²æˆ–é«’è³‡æ–™ï¼Œé€™è£¡æœƒè¢« skip
            except (ValueError, TypeError):
                continue

        ps = window.passengers.to_py()
        if not ps:
            document.querySelector("#py-output").innerText = "æé†’ï¼šåœ°åœ–ä¸Šæ²’æœ‰ä¹˜å®¢ã€‚"
            return

        # --- [1. å»ºç«‹åˆå§‹å€™é¸é»æ¸…å–®] ---
        candidates_raw = []

        # A. ä¹˜å®¢é» (éœ€é€£é€š)
        for p in ps:
            if is_reachable(p, walls):
                candidates_raw.append({'x': int(p['x']), 'y': int(p['y'])})

        # B. K-Means èšé¡ä¸­å¿ƒ
        # å˜—è©¦ä¸åŒçš„ç¾¤çµ„æ•¸é‡ï¼Œé€™å¯ä»¥æ‰¾åˆ°ã€Œå¤šå€‹ä¹˜å®¢çš„ä¸­é–“é»ã€
        max_k = min(len(ps), 5)
        for k in range(2, max_k + 1):
            centers = simple_kmeans(ps, k)
            for c in centers:
                cx, cy = int(c['x']), int(c['y'])
                
                # é€™æ˜¯é—œéµä¿®æ­£ï¼šå¦‚æœä¸­å¿ƒé»ä¸åˆæ³•ï¼Œé€²è¡Œã€Œèºæ—‹æœå°‹ã€æ‰¾åˆ°æœ€è¿‘çš„åˆæ³•ç©ºåœ°
                if not is_reachable({'x': cx, 'y': cy}, walls):
                    found_valid = False
                    # æ“´å¤§æœå°‹ç¯„åœåˆ°åŠå¾‘ 2 (5x5 å€åŸŸ)
                    for r in range(1, 3): 
                        for dx in range(-r, r + 1):
                            for dy in range(-r, r + 1):
                                test_c = {'x': cx + dx, 'y': cy + dy}
                                if is_reachable(test_c, walls):
                                    candidates_raw.append(test_c)
                                    found_valid = True
                                    break
                            if found_valid: break
                        if found_valid: break
                    # å¦‚æœ 5x5 éƒ½æ‰¾ä¸åˆ°åˆæ³•é»ï¼Œä»£è¡¨é€™å€å…¨æ˜¯ç‰†ï¼Œç›´æ¥æ”¾æ£„é€™å€‹ä¸­å¿ƒé»
                else:
                    candidates_raw.append({'x': cx, 'y': cy})

        # --- [2. ç§»é™¤é‡è¤‡çš„å€™é¸é»] ---
        unique_candidates = []
        seen = set()
        for c in candidates_raw:
            pos = (int(c['x']), int(c['y']))
            if pos not in seen:
                unique_candidates.append(c)
                seen.add(pos)

        # --- [3. åŸ·è¡Œè²ªå©ªé¸å€] ---
        current_ss = [] 
        best_cost = get_total_cost(current_ss, ps, walls, w1, w2, s_cost, c_bus)
        
        print(f"å€™é¸é»ç¸½æ•¸: {len(unique_candidates)}")
        START_A = {'x': 1, 'y': 1}
        END_B = {'x': 18, 'y': 18}

        while True:
            best_candidate = None
            for cand in unique_candidates:
                if any(s['x'] == cand['x'] and s['y'] == cand['y'] for s in current_ss):
                    continue
                
                # --- é—œéµä¿®æ­£é» ---
                # ä¸è¦ç›´æ¥åŠ åœ¨æœ€å¾Œï¼Œè€Œæ˜¯å…ˆæ‰¾å‡ºã€Œå¦‚æœåŠ å…¥é€™å€‹é»ï¼Œæœ€é †è·¯çš„é †åºæ˜¯ä»€éº¼ã€
                temp_list = current_ss + [cand]
                sorted_test_ss = sort_stations_insertion(START_A, END_B, temp_list)
                
                # ç”¨æ’åºå¾Œçš„é †åºè¨ˆç®—æˆæœ¬
                test_cost = get_total_cost(sorted_test_ss, ps, walls, w1, w2, s_cost, c_bus)
                
                if test_cost < best_cost:
                    best_cost = test_cost
                    best_candidate = cand
            
            if best_candidate:
                current_ss.append(best_candidate)
                # ç‚ºäº†ä¸‹ä¸€æ¬¡å¾ªç’°ï¼Œé€™è£¡ä¹Ÿå¯ä»¥ä¿æŒ current_ss æ˜¯æ’åºéçš„ï¼Œæˆ–è€…ä¸æ’ä¹Ÿå¯ä»¥ï¼Œ
                # å› ç‚ºå¾ªç’°é–‹é ­æœƒé‡æ–°è·‘ sort_stations_insertion
                current_ss = sort_stations_insertion(START_A, END_B, current_ss)
                print(f"æ–°å¢å„ªåŒ–ç«™é»: ({best_candidate['x']}, {best_candidate['y']})")
            else:
                break 

        # æœ€çµ‚è¼¸å‡ºå‰å†ç¢ºä¿ä¸€æ¬¡é †åº
        final_ss = sort_stations_insertion(START_A, END_B, current_ss)
        window.updateStationsFromPy(final_ss)
        run_optimization()

    except Exception as e:
        import traceback
        document.querySelector("#py-output").innerText = f"å„ªåŒ–å¤±æ•—: {e}\n{traceback.format_exc()}"


window.autoOptimize = auto_optimize
window.runOptimization = run_optimization
document.querySelector("#pyscript-loading").style.display = "none"
</script>

</body>
</html>